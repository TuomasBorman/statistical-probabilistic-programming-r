<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Introduction to Probabilistic Programming in R: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="../assets/styles.css">
<script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [ ['$','$'], ['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="manifest" href="../site.webmanifest">
<link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav incubator"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><abbr class="icon" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="text-decoration: unset">
          Â 
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #383838">Pre-Alpha
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="color: #FF4955; border-radius: 5px"></i>
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container ">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='../aio.html';">Learner View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Introduction to Probabilistic Programming in R
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
      <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Introduction to Probabilistic Programming in R
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"></ul>
</li>
      </ul>
</div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
<input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset>
</form>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Introduction to Probabilistic Programming in R
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
  <div id="sidebar-col" class="col-lg-4">
    <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle"><i class="search-icon" data-feather="x" role="img"></i></button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../aio.html">Learner View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->
      
            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="setup.html">1. Setup</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="bayesian-statistics.html">2. Bayesian Statistics</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="sampling.html">3. Working with samples</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="stan.html">4. Stan</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="mcmc.html">5. MCMC</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="hierarchical-models.html">6. Hierarchical Models</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="model-critisism.html">7. Model checking</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="other-topics.html">8. Other topics</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="recommended-reading.html">9. further-materials</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="exercises.html">10. exercises</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width resources">
<a href="../instructor/aio.html">See all in one page</a>

            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">
            
            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-setup"><p>Content from <a href="setup.html">Setup</a></p>
<hr>
<p> Last updated on 2023-06-27 | 
        
        <a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/edit/main/episodes/setup.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<p>FIXME: Setup instructions live in this document. Please specify the
tools and the data sets the Learner needs to have installed.</p>
<section id="data-sets"><h2 class="section-heading">Data Sets<a class="anchor" aria-label="anchor" href="#data-sets"></a>
</h2>
<hr class="half-width">
<!--
FIXME: place any data you want learners to use in `episodes/data` and then use
       a relative link ( [data zip file](data/lesson-data.zip) ) to provide a
       link to it, replacing the example.com link.
--><p>Download the <a href="https://example.com/FIXME" class="external-link">data zip file</a>
and unzip it to your Desktop</p>
</section><section id="software-setup"><h2 class="section-heading">Software Setup<a class="anchor" aria-label="anchor" href="#software-setup"></a>
</h2>
<hr class="half-width">
<div id="details" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="details" class="callout-inner">
<h3 class="callout-title">Details<a class="anchor" aria-label="anchor" href="#details"></a>
</h3>
<div class="callout-content">
<p>Setup for different systems can be presented in dropdown menus via a
<code>solution</code> tag. They will join to this discussion block, so
you can give a general overview of the software used in this lesson here
and fill out the individual operating systems (and potentially add more,
e.g.Â online setup) in the solutions blocks.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Windows
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>Use PuTTY</p>
</div>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  MacOS
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>Use Terminal.app</p>
</div>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">
  Linux
  </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<p>Use Terminal</p>
</div>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-bayesian-statistics"><p>Content from <a href="bayesian-statistics.html">Bayesian Statistics</a></p>
<hr>
<p> Last updated on 2023-06-27 | 
        
        <a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/edit/main/episodes/bayesian-statistics.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is Bayesian statistics?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand the basic idea of Bayesian statistical thinking.</li>
<li>Bayesian formula: prior, likelihood, posterior</li>
<li>Implement grid approximation for a Bayesian model</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="introduction"><h2 class="section-heading">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<hr class="half-width">
<p>The fundamental ingredient of Bayesian statistics and probabilistic
thinking is the Bayesâ theorem, stated as</p>
<p><span class="math display">\[
  p(\theta | X) = \frac{p(\theta)  p(X | \theta)}{p(X)} \\
\]</span></p>
<p>Given a statistical model, the theorem can be used to infer
probabilities of the values of the model parameters <span class="math inline">\(\theta\)</span> conditional on the available data
<span class="math inline">\(X\)</span>. These probabilities are
quantified by the <em>posterior distribution</em> <span class="math inline">\(p(\theta | X)\)</span>. The <em>prior
distribution</em> <span class="math inline">\(p(\theta)\)</span> is used
to impose beliefs about <span class="math inline">\(\theta\)</span>
without taking the data into account. The <em>likelihood function</em>
<span class="math inline">\(p(X | \theta)\)</span> gives the probability
of the data conditional <span class="math inline">\(\theta\)</span> and
specifies the effect of data on the posterior. The denominator on the
right-hand side <span class="math inline">\(p(X)\)</span> is called the
marginal probability, which is often practically impossible to compute,
and usually the proportional version of the Bayesâ formula is used:</p>
<p><span class="math display">\[
p(\theta | X) \propto p(\theta)  p(X | \theta).
\]</span></p>
<p>The proportional Bayesâ formula produces an unnormalized posterior
distribution which can then be normalized to access the normalized
posterior.</p>
</section><section id="example-handedness"><h2 class="section-heading">Example: handedness<a class="anchor" aria-label="anchor" href="#example-handedness"></a>
</h2>
<hr class="half-width">
<p>Let us illustrate the use of the Bayesâ theorem with an example.</p>
<p>Assume we are interested in estimating the prevalence of
left-handedness based on a sample of 50 children. In this sample 7
children reported left-handedness and 43 were right-handed. Since the
outcome is binary and the children independent (assumption) we can model
left-handedness with the binomial distribution:</p>
<p><span class="math display">\[
\text{Number of left-handed} \sim Bin(n, p)
\]</span></p>
<p>The parameters <span class="math inline">\(n\)</span> and <span class="math inline">\(p\)</span> refer to the total number of children
and proportion of the left-handed in the population, respectively. The
likelihood for the data is <span class="math inline">\(p(X|\theta) =
Bin(7 | 50, p).\)</span></p>
<p>Next, we should think what sort of prior information weâd like to
use. For instance, the following distributions might be considered:
<span class="math inline">\(Unif(0, 1); \, N(0, 1)\)</span> and <span class="math inline">\(Beta(1, 10)\)</span>.</p>
<div id="discussion1" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Discussion<a class="anchor" aria-label="anchor" href="#discussion1"></a>
</h3>
<div class="callout-content">
<p>What could be the rationale for choosing each of these prior
distributions?</p>
</div>
</div>
</div>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" aria-labelledby="headingInstructor1" data-bs-parent="#accordionInstructor1">
<div class="accordion-body">
<p>For example:</p>
<ul>
<li>uniform = absolutely no idea about <span class="math inline">\(p\)</span> a-priori</li>
<li>normal = a parsimonious distribution, often a good choice</li>
<li>Beta = conjugate prior, hyperparameters can be interpreted as prior
data, 1 out of 10+1 people is a leftie.</li>
</ul>
<p>Extra-reading: BDA p.34: interpreting hyperparameters as prior data,
conjugate prior</p>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="grid-approximation">Grid approximation<a class="anchor" aria-label="anchor" href="#grid-approximation"></a>
</h3>
<p>In many cases, analytical computations of the posterior are not
feasible and approximation methods need to be used. Although the
analytical posterior for the binomial model (with Beta prior) is
available, weâll next illustrate fitting this model with a grid
approximation.</p>
<p>The grid approximation is a method for approximating the posterior
distribution. The idea is to discretize the parameter space into a grid
and then calculate the likelihood and prior at each grid point. The
product of these values forms the approximate unnormalized posterior. To
obtain a proper probability distribution, the unnormalized posterior is
then normalized by dividing each value by the sum of all values times
the discretization interval (in 1D, area in 2D etc.). This results in an
approximation of the posterior distribution.</p>
<p>In R, the model can be implemented as follows. First we define the
data variables:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sample size</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span></span>
<span><span class="co"># 7/50 are left-handed</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">7</span></span>
<span></span>
<span><span class="co"># Define a grid of points in the interval [0, 1], with 0.01 interval</span></span>
<span><span class="va">delta</span> <span class="op">&lt;-</span> <span class="fl">0.01</span></span>
<span><span class="va">p_grid</span> <span class="op">&lt;-</span> <span class="fu">seq</span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">1</span>, by <span class="op">=</span> <span class="va">delta</span><span class="op">)</span></span></code></pre>
</div>
<p>Next, weâll define the likelihood, uniform prior and posterior
functions.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">likelihood</span> <span class="op">&lt;-</span> <span class="fu">dbinom</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, size <span class="op">=</span> <span class="va">N</span>, prob <span class="op">=</span> <span class="va">p_grid</span><span class="op">)</span></span>
<span><span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu">rep</span><span class="op">(</span><span class="fl">1</span>, <span class="fu">length</span><span class="op">(</span><span class="va">p_grid</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">posterior</span> <span class="op">&lt;-</span> <span class="va">likelihood</span><span class="op">*</span><span class="va">prior</span></span>
<span></span>
<span><span class="co"># normalize posterior</span></span>
<span><span class="va">posterior</span> <span class="op">&lt;-</span> <span class="va">posterior</span><span class="op">/</span><span class="op">(</span><span class="fu">sum</span><span class="op">(</span><span class="va">posterior</span><span class="op">)</span><span class="op">*</span><span class="va">delta</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make data frame</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">data.frame</span><span class="op">(</span>p <span class="op">=</span> <span class="va">p_grid</span>, <span class="va">likelihood</span>, <span class="va">prior</span>, <span class="va">posterior</span><span class="op">)</span></span></code></pre>
</div>
<p>Finally, we can plot these functions</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># wide to long format</span></span>
<span><span class="va">df_l</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">gather</span><span class="op">(</span>key <span class="op">=</span> <span class="st">"func"</span>, value <span class="op">=</span> <span class="st">"value"</span>, <span class="op">-</span><span class="va">p</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">df_l</span>, </span>
<span>       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">func</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_grafify</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span></span></code></pre>
</div>
<figure><img src="../fig/bayesian-statistics-rendered-unnamed-chunk-4-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="accordionInstructor2" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor2" aria-expanded="false" aria-controls="collapseInstructor2">
  <h3 class="accordion-header" id="headingInstructor2">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor2" class="accordion-collapse collapse" aria-labelledby="headingInstructor2" data-bs-parent="#accordionInstructor2">
<div class="accordion-body">
<p>Take a moment to analyze the figure.</p>
</div>
</div>
</div>
</div>
<p>Notice that the likelihood function is not a distribution in terms of
the parameter <span class="math inline">\(p\)</span>, so it doesnât sum
to one. Below, we normalize it for better illustration.</p>
<p>Now that we have a posterior distribution (approximation) available,
we can try to quantify it by computing features of it. The mode (maximum
a posteriori, or MAP), average and variance and commonly employed point
estimates:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">data.frame</span><span class="op">(</span>Estimate <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"Mode"</span>, <span class="st">"Mean"</span>, <span class="st">"Variance"</span><span class="op">)</span>, </span>
<span>           Value <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="va">df</span><span class="op">[</span><span class="fu">which.max</span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">posterior</span><span class="op">)</span>, <span class="st">"p"</span><span class="op">]</span>,</span>
<span>                     <span class="fu">sum</span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">p</span><span class="op">*</span><span class="va">df</span><span class="op">$</span><span class="va">posterior</span><span class="op">*</span><span class="va">delta</span><span class="op">)</span>, </span>
<span>                     <span class="fu">sum</span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">p</span><span class="op">^</span><span class="fl">2</span><span class="op">*</span><span class="va">df</span><span class="op">$</span><span class="va">posterior</span><span class="op">*</span><span class="va">delta</span><span class="op">)</span> <span class="op">-</span> <span class="fu">sum</span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">p</span><span class="op">*</span><span class="va">df</span><span class="op">$</span><span class="va">posterior</span><span class="op">*</span><span class="va">delta</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>  Estimate      Value
1     Mode 0.14000000
2     Mean 0.15384615
3 Variance 0.00245618</code></pre>
</div>
<div id="discussion2" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Discussion<a class="anchor" aria-label="anchor" href="#discussion2"></a>
</h3>
<div class="callout-content">
<p>These are point estimates. What information do they give? What is
absent? Think of other ways in which you could quantify the posterior.
How could you quantify the uncertainty.</p>
<p>What is the conclusion of the analysis in terms of handedness?</p>
</div>
</div>
</div>
<div id="accordionInstructor3" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor3" aria-expanded="false" aria-controls="collapseInstructor3">
  <h3 class="accordion-header" id="headingInstructor3">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor3" class="accordion-collapse collapse" aria-labelledby="headingInstructor3" data-bs-parent="#accordionInstructor3">
<div class="accordion-body">
<p>Actual value from a study from 1975 with 7,688 children in US grades
1-6 was 9.6%</p>
<p>Hardyck, C. et al.Â (1976), Left-handedness and cognitive deficit <a href="https://en.wikipedia.org/wiki/Handedness" class="external-link uri">https://en.wikipedia.org/wiki/Handedness</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="effect-of-the-prior">Effect of the prior<a class="anchor" aria-label="anchor" href="#effect-of-the-prior"></a>
</h3>
<p>Next, letâs compare the effect of the prior, using the distributions
mentioned above.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">uniform_prior</span> <span class="op">&lt;-</span> <span class="fu">dunif</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p_grid</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">normal_prior</span> <span class="op">&lt;-</span> <span class="fu">dnorm</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p_grid</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">beta_prior</span> <span class="op">&lt;-</span> <span class="fu">dbeta</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p_grid</span>, shape1 <span class="op">=</span> <span class="fl">2</span>, shape2 <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">posterior1</span> <span class="op">&lt;-</span> <span class="va">likelihood</span><span class="op">*</span><span class="va">uniform_prior</span><span class="op">/</span><span class="op">(</span><span class="fu">sum</span><span class="op">(</span><span class="va">likelihood</span><span class="op">*</span><span class="va">uniform_prior</span><span class="op">)</span><span class="op">*</span><span class="va">delta</span><span class="op">)</span></span>
<span><span class="va">posterior2</span> <span class="op">&lt;-</span> <span class="va">likelihood</span><span class="op">*</span><span class="va">normal_prior</span><span class="op">/</span><span class="op">(</span><span class="fu">sum</span><span class="op">(</span><span class="va">likelihood</span><span class="op">*</span><span class="va">normal_prior</span><span class="op">)</span><span class="op">*</span><span class="va">delta</span><span class="op">)</span></span>
<span><span class="va">posterior3</span> <span class="op">&lt;-</span> <span class="va">likelihood</span><span class="op">*</span><span class="va">beta_prior</span><span class="op">/</span><span class="op">(</span><span class="fu">sum</span><span class="op">(</span><span class="va">likelihood</span><span class="op">*</span><span class="va">beta_prior</span><span class="op">)</span><span class="op">*</span><span class="va">delta</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Normalized likelihood</span></span>
<span><span class="va">likelihood</span> <span class="op">&lt;-</span> <span class="va">likelihood</span><span class="op">/</span><span class="op">(</span><span class="fu">sum</span><span class="op">(</span><span class="va">likelihood</span><span class="op">)</span><span class="op">*</span><span class="va">delta</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">df2</span> <span class="op">&lt;-</span> <span class="fu">data.frame</span><span class="op">(</span>p <span class="op">=</span> <span class="fu">rep</span><span class="op">(</span><span class="va">p_grid</span>, <span class="fl">3</span><span class="op">)</span>, </span>
<span>                  likelihood <span class="op">=</span> <span class="fu">rep</span><span class="op">(</span><span class="va">likelihood</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>                  prior <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="va">uniform_prior</span>,  <span class="va">normal_prior</span>, <span class="va">beta_prior</span><span class="op">)</span>, </span>
<span>                  posterior <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="va">posterior1</span>, <span class="va">posterior2</span>, <span class="va">posterior3</span><span class="op">)</span>, </span>
<span>                  prior_type <span class="op">=</span> <span class="fu">rep</span><span class="op">(</span><span class="fu">c</span><span class="op">(</span><span class="st">"uniform"</span>, <span class="st">"normal"</span>, <span class="st">"beta"</span><span class="op">)</span>,</span>
<span>                                   each <span class="op">=</span> <span class="fu">length</span><span class="op">(</span><span class="va">p_grid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df2_w</span> <span class="op">&lt;-</span> <span class="va">df2</span> <span class="op">%&gt;%</span> <span class="fu">gather</span><span class="op">(</span>key <span class="op">=</span> <span class="st">"func"</span>, value <span class="op">=</span> <span class="st">"value"</span>, <span class="op">-</span><span class="fu">c</span><span class="op">(</span><span class="va">p</span>, <span class="va">prior_type</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span><span class="fu">ggplot</span><span class="op">(</span><span class="va">df2_w</span>,</span>
<span>         <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">func</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">prior_type</span>,</span>
<span>               scales <span class="op">=</span> <span class="st">"free"</span>, </span>
<span>               ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_grafify</span><span class="op">(</span><span class="op">)</span></span>
<span>    </span>
<span><span class="va">p2</span>    </span></code></pre>
</div>
<figure><img src="../fig/bayesian-statistics-rendered-unnamed-chunk-6-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="discussion3" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#discussion3"></a>
</h3>
<div class="callout-content">
<p>Play around with the parameters of the prior distributions and see
how it affects the posterior.</p>
</div>
</div>
</div>
<p>The main limitation of the grid approximation method is that it
becomes impractical for models with a large number of parameters. The
reason is that the number of computations grows as <span class="math inline">\(O \{ n^p \}\)</span> where <span class="math inline">\(n\)</span> is the number of grid points per model
parameter and <span class="math inline">\(p\)</span> the number of
parameters. This quickly becomes prohibitive, and the grid approximation
is seldom used in practice. The standard approach to posterior
computations is to draw samples from it with Markov chain Monte Carlo
(MCMC) methods, which we will go through later. In the following
episodes, we will learn how to perform computations on samples drawn
from a distribution and eventually implement our own MCMC
algorithms.</p>
</div>
</section><section id="example-normal-model"><h2 class="section-heading">Example: normal model<a class="anchor" aria-label="anchor" href="#example-normal-model"></a>
</h2>
<hr class="half-width">
<p>Let us implement another standard statistical model, the normal
model, with the grid approximation. Weâll assume that the variance of
the model in known, <span class="math inline">\(\sigma^2=1,\)</span> and
weâd like to learn the mean parameter <span class="math inline">\(\mu.\)</span></p>
<p>Let us first generate some data from the model, 5 independent
observations from a normal distribution with unknown mean parameter:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sample size</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span></span>
<span><span class="co"># Generate data</span></span>
<span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">unknown_mu</span> <span class="op">&lt;-</span> <span class="fu">runif</span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">rnorm</span><span class="op">(</span>n <span class="op">=</span> <span class="va">N</span>,</span>
<span>           mean <span class="op">=</span> <span class="va">unknown_mu</span>,</span>
<span>           sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span> </span>
<span></span>
<span></span>
<span><span class="co"># Define a grid of points for mu</span></span>
<span><span class="va">delta</span> <span class="op">&lt;-</span> <span class="fl">0.01</span></span>
<span><span class="va">mu_grid</span> <span class="op">&lt;-</span> <span class="fu">seq</span><span class="op">(</span>from <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, to <span class="op">=</span> <span class="fl">5</span>, by <span class="op">=</span> <span class="va">delta</span><span class="op">)</span></span></code></pre>
</div>
<p>Similarly as before, weâll then define the prior, likelihood, and
compute posterior distribution. Weâll use a normal prior with mean 0 and
standard deviation 1 for <span class="math inline">\(\mu\)</span>. As
the observations are assumed to be independent, the likelihood function
is product of the likelihoods of the individual points:</p>
<p><span class="math display">\[p(X | \theta) = \prod_{i = 1}^{N} p(X_i
| \theta),\]</span></p>
<p>where <span class="math inline">\(X_i\)</span> are individual data
points and <span class="math inline">\(N\)</span> the sample size.</p>
<p><span class="math display">\[\log p(X | \theta) = \sum_{i = 1}^{N}
\log p(X_i | \theta)\]</span></p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Implement the grid approximation the normal model with the generated
data as described above.</p>
<p>Work with logarithms to avoid underflow.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">data.frame</span><span class="op">(</span>mu <span class="op">=</span> <span class="va">mu_grid</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Log likelihood</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">nrow</span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># print(i)</span></span>
<span>  <span class="va">df</span><span class="op">[</span><span class="va">i</span>, <span class="st">"log_likelihood"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">sum</span><span class="op">(</span><span class="fu">dnorm</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>,</span>
<span>                                   mean <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="va">i</span>, <span class="st">"mu"</span><span class="op">]</span>, sd <span class="op">=</span> <span class="va">sigma</span>,</span>
<span>                                   log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>likelihood <span class="op">=</span> <span class="fu">exp</span><span class="op">(</span><span class="va">log_likelihood</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prior: mu ~ N(0, 1)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>log_prior <span class="op">=</span> <span class="fu">dnorm</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mu</span>,</span>
<span>                           mean <span class="op">=</span> <span class="fl">0</span> ,</span>
<span>                           sd <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                           log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>prior <span class="op">=</span> <span class="fu">exp</span><span class="op">(</span><span class="va">log_prior</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Posterior</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>log_posterior <span class="op">=</span> <span class="va">log_prior</span> <span class="op">+</span> <span class="va">log_likelihood</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>posterior <span class="op">=</span> <span class="fu">exp</span><span class="op">(</span><span class="va">log_posterior</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>posterior <span class="op">=</span> <span class="va">posterior</span><span class="op">/</span><span class="op">(</span><span class="fu">sum</span><span class="op">(</span><span class="va">posterior</span><span class="op">)</span><span class="op">*</span><span class="va">delta</span><span class="op">)</span><span class="op">)</span> <span class="co"># normalize</span></span>
<span></span>
<span><span class="co"># Normalize likelihood (for better illustration)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>likelihood <span class="op">=</span> <span class="va">likelihood</span><span class="op">/</span><span class="op">(</span><span class="fu">sum</span><span class="op">(</span><span class="va">likelihood</span><span class="op">)</span><span class="op">*</span><span class="va">delta</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Now, we can plot the prior, likelihood, and posterior, along with the
unknown true value of <span class="math inline">\(\mu\)</span> (black
vertical line).</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Wide --&gt; long format</span></span>
<span><span class="va">df_l</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather</span><span class="op">(</span>key <span class="op">=</span> <span class="st">"func"</span>, value <span class="op">=</span> <span class="st">"value"</span>, <span class="op">-</span><span class="fu">c</span><span class="op">(</span><span class="st">"mu"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># In log scale</span></span>
<span><span class="va">p_log</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">df_l</span> <span class="op">%&gt;%</span> </span>
<span>         <span class="fu">filter</span><span class="op">(</span><span class="fu">grepl</span><span class="op">(</span><span class="st">"log"</span>, <span class="va">func</span><span class="op">)</span><span class="op">)</span>, </span>
<span>       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mu</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">func</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">unknown_mu</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># In regular scale</span></span>
<span><span class="va">p_reg</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">df_l</span> <span class="op">%&gt;%</span> </span>
<span>         <span class="fu">filter</span><span class="op">(</span><span class="op">!</span><span class="fu">grepl</span><span class="op">(</span><span class="st">"log"</span>, <span class="va">func</span><span class="op">)</span><span class="op">)</span>, </span>
<span>       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mu</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">func</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">unknown_mu</span>, </span>
<span>             color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_grafify</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_reg</span></span></code></pre>
</div>
<figure><img src="../fig/bayesian-statistics-rendered-unnamed-chunk-9-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="discussion4" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Discussion<a class="anchor" aria-label="anchor" href="#discussion4"></a>
</h3>
<div class="callout-content">
<p>Play around with different samples sizes <span class="math inline">\(N\)</span> and priors for <span class="math inline">\(\mu\)</span> and see how the results change.</p>
<p>What happens if the true value of <span class="math inline">\(\mu\)</span> is not within the defined grid?</p>
</div>
</div>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge2"></a>
</h3>
<div class="callout-content">
<p>Implement the grid approximation with both unkown mean <span class="math inline">\(\mu\)</span> and standard deviation <span class="math inline">\(\sigma:\)</span></p>
<ol style="list-style-type: decimal">
<li>Generate data</li>
<li>Define grid for <span class="math inline">\(mu\)</span> and <span class="math inline">\(sigma\)</span>
</li>
<li>Compute prior, likelihood and posterior at grid points</li>
</ol>
<ul>
<li>Use normal and gamma priors for <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>, respectively
<ul>
<li>The prior is the product of priors of <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>
</li>
</ul>
</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Plot prior, likelihood and posterior (in 2D)</li>
<li>Compute marginal prior, likelihood and posterior for <span class="math inline">\(\mu\)</span>
</li>
</ol>
<ul>
<li>Marginalize (integrate) over sigma</li>
<li>Normalize</li>
<li>Plot</li>
</ul>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>Included in the instructorâs notes.</p>
</div>
</div>
</div>
</div>
<div id="accordionInstructor4" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor4" aria-expanded="false" aria-controls="collapseInstructor4">
  <h3 class="accordion-header" id="headingInstructor4">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor4" class="accordion-collapse collapse" aria-labelledby="headingInstructor4" data-bs-parent="#accordionInstructor4">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Data *************************** ####</span></span>
<span></span>
<span><span class="co"># Sample size</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">15</span></span>
<span></span>
<span></span>
<span><span class="co"># Generate data</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">rnorm</span><span class="op">(</span>n <span class="op">=</span> <span class="va">N</span>, mean <span class="op">=</span> <span class="fl">2.5</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="co"># mu = 2.5, sigma = 0.5</span></span>
<span></span>
<span></span>
<span><span class="co"># Define a grid of points for mu</span></span>
<span><span class="va">delta</span> <span class="op">&lt;-</span> <span class="fl">0.01</span></span>
<span><span class="va">mu_grid</span> <span class="op">&lt;-</span> <span class="fu">seq</span><span class="op">(</span>from <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, to <span class="op">=</span> <span class="fl">5</span>, by <span class="op">=</span> <span class="va">delta</span><span class="op">)</span></span>
<span><span class="va">sigma_grid</span> <span class="op">&lt;-</span> <span class="fu">seq</span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0.01</span>, to <span class="op">=</span> <span class="fl">2</span>, by <span class="op">=</span> <span class="va">delta</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co">## Fit model ********************** ####</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">expand.grid</span><span class="op">(</span>mu <span class="op">=</span> <span class="va">mu_grid</span>, sigma <span class="op">=</span> <span class="va">sigma_grid</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Log likelihood</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">nrow</span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># print(i)</span></span>
<span>  <span class="va">df</span><span class="op">[</span><span class="va">i</span>, <span class="st">"log_likelihood"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">sum</span><span class="op">(</span><span class="fu">dnorm</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>,</span>
<span>                                   mean <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="va">i</span>, <span class="st">"mu"</span><span class="op">]</span>, sd <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="va">i</span>, <span class="st">"sigma"</span><span class="op">]</span>,</span>
<span>                                   log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>likelihood <span class="op">=</span> <span class="fu">exp</span><span class="op">(</span><span class="va">log_likelihood</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Priors: mu ~ N(0, 5), sigma ~ Gamma(2, 1)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>log_prior <span class="op">=</span> <span class="fu">dnorm</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mu</span>,</span>
<span>                           mean <span class="op">=</span> <span class="fl">0</span> ,</span>
<span>                           sd <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                           log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu">dgamma</span><span class="op">(</span>x <span class="op">=</span> <span class="va">sigma</span>, </span>
<span>                                                shape <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                                scale <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                                log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>prior <span class="op">=</span> <span class="fu">exp</span><span class="op">(</span><span class="va">log_prior</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Posterior</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>log_posterior <span class="op">=</span> <span class="va">log_prior</span> <span class="op">+</span> <span class="va">log_likelihood</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>posterior <span class="op">=</span> <span class="fu">exp</span><span class="op">(</span><span class="va">log_posterior</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>posterior <span class="op">=</span> <span class="va">posterior</span><span class="op">/</span><span class="op">(</span><span class="fu">sum</span><span class="op">(</span><span class="va">posterior</span><span class="op">)</span><span class="op">*</span><span class="va">delta</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="co"># normalize</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="va">p_posterior</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, </span>
<span>             <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mu</span>, y <span class="op">=</span> <span class="va">sigma</span>, fill <span class="op">=</span> <span class="va">posterior</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_tile</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colours <span class="op">=</span> <span class="fu">rainbow</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_likelihood</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, </span>
<span>                      <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mu</span>, y <span class="op">=</span> <span class="va">sigma</span>, fill <span class="op">=</span> <span class="va">likelihood</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_tile</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colours <span class="op">=</span> <span class="fu">rainbow</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_prior</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, </span>
<span>                       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mu</span>, y <span class="op">=</span> <span class="va">sigma</span>, fill <span class="op">=</span> <span class="va">prior</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_tile</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>colours <span class="op">=</span> <span class="fu">rainbow</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">plot_grid</span><span class="op">(</span><span class="va">p_prior</span>, <span class="va">p_likelihood</span>, <span class="va">p_posterior</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Marginalize ******************** ####</span></span>
<span></span>
<span><span class="co"># long to wide format</span></span>
<span><span class="va">df_w</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="fu">c</span><span class="op">(</span><span class="va">log_likelihood</span>, <span class="va">log_prior</span>, <span class="va">log_posterior</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">gather</span><span class="op">(</span>key <span class="op">=</span> <span class="st">"func"</span>, value <span class="op">=</span> <span class="st">"value"</span>, <span class="op">-</span><span class="fu">c</span><span class="op">(</span><span class="va">mu</span>, <span class="va">sigma</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">df_w_marginal</span> <span class="op">&lt;-</span> <span class="va">df_w</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">mu</span>, <span class="va">func</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarise</span><span class="op">(</span>marginal_distribution <span class="op">=</span> <span class="fu">sum</span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># integrate over sigma</span></span>
<span>  <span class="va">ungroup</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">func</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># normalize marginal distributions</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>marginal_distribution <span class="op">=</span> <span class="va">marginal_distribution</span><span class="op">/</span><span class="op">(</span><span class="fu">sum</span><span class="op">(</span><span class="va">marginal_distribution</span><span class="op">)</span><span class="op">*</span><span class="va">delta</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_marginal</span> <span class="op">&lt;-</span> <span class="va">df_w_marginal</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mu</span>, y <span class="op">=</span> <span class="va">marginal_distribution</span>, color <span class="op">=</span> <span class="va">func</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Likelihood determines the probability of data conditional on the
model parameters</li>
<li>Prior distribution encodes prior beliefs about the model
parameters</li>
<li>Posterior distribution quantifies the probability of parameter
values conditional on the data.</li>
<li>Posterior is a compromise between the data and prior. The less data
available, the bigger the effect of the prior.</li>
<li>The grid approximation is a means for accessing posterior
distributions which may be difficult to compute analytically</li>
</ul>
</div>
</div>
</div>
</section><section id="reading"><h2 class="section-heading">Reading<a class="anchor" aria-label="anchor" href="#reading"></a>
</h2>
<hr class="half-width">
<ul>
<li>Gelman <em>et al.</em>, Bayesian Data Analysis (3rd ed.): Ch. 1,
2</li>
<li>McElreath, Statistical Rethinking (2nd ed.): Ch. 2</li>
</ul>
<div id="accordionInstructor5" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor5" aria-expanded="false" aria-controls="collapseInstructor5">
  <h3 class="accordion-header" id="headingInstructor5">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor5" class="accordion-collapse collapse" aria-labelledby="headingInstructor5" data-bs-parent="#accordionInstructor5">
<div class="accordion-body">
<p>Here are some exercises that can be used as additional
challenges.</p>
<ol style="list-style-type: decimal"><li>
</li></ol>
</div>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-sampling"><p>Content from <a href="sampling.html">Working with samples</a></p>
<hr>
<p> Last updated on 2023-06-27 | 
        
        <a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/edit/main/episodes/sampling.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do you work with posterior samples?</li>
<li>How can the posterior information be handled?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Learn how to
<ul>
<li>work with posterior samples</li>
<li>compute posterior intervals</li>
<li>compute probabilities for parameter ranges and sets</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>In the previous episode, we were introduced to the Bayesian formula
and learned how to fit binomial and normal models using the grid
approximation. However, the poor scalability of the grid approximation
makes it impractical to use on models of even moderate size. To overcome
this challenge, the standard solution is to employ Markov chain Monte
Carlo (MCMC) methods, which involve drawing random samples from the
posterior distribution. While we will delve into MCMC methods in
subsequent lessons, we will now learn working with samples.</p>
<section id="example-binomial-model"><h2 class="section-heading">Example: binomial model<a class="anchor" aria-label="anchor" href="#example-binomial-model"></a>
</h2>
<hr class="half-width">
<p>Letâs revisit the binomial model considered in the previous episode.
The binomial model with a beta distribution is an example of a model
where the analytical shape of the posterior is known.</p>
<p><span class="math display">\[p(\theta | X) = Beta(\alpha + x, \beta +
N - x),\]</span> where <span class="math inline">\(\alpha\)</span> and
<span class="math inline">\(\beta\)</span> are the hyperparameters of
the Beta prior and <span class="math inline">\(x\)</span> the number of
successes out of <span class="math inline">\(N\)</span> trials.</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Derive the analytical posterior distribution for the Beta-Binomial
model.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p><span class="math display">\[\begin{align}
p(\theta | X) &amp;\propto  p(X | \theta) p(\theta) \\
              &amp;= ...
\end{align}\]</span></p>
</div>
</div>
</div>
</div>
<p>Letâs generate samples from the prior and posterior distributions,
using the handedness data of the previous episode. First redefine the
data.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sample size</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span></span>
<span><span class="co"># 7/50 are left-handed</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">7</span></span></code></pre>
</div>
<p>Then, weâll draw 5000 samples from the prior and posterior
distributions. In R, the standard statistical distributions can be
sampled from using readily available functions. For instance, the
binomial, normal and beta distributions can be sampled, respectively,
with <code>rbinom, rnorm</code> and <code>rbeta</code> functions.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Number of samples</span></span>
<span><span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">5000</span></span>
<span></span>
<span><span class="co"># Prior is Beta(1, 10)</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="co"># Draw random values from the prior</span></span>
<span><span class="va">prior_samples</span> <span class="op">&lt;-</span> <span class="fu">rbeta</span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>                       shape1 <span class="op">=</span> <span class="va">alpha</span>,</span>
<span>                       shape2 <span class="op">=</span> <span class="va">beta</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Draw random values from the posterior</span></span>
<span><span class="va">posterior_samples</span> <span class="op">&lt;-</span> <span class="fu">rbeta</span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>                           shape1 <span class="op">=</span> <span class="va">alpha</span> <span class="op">+</span> <span class="va">x</span>, </span>
<span>                           shape2 <span class="op">=</span> <span class="va">beta</span> <span class="op">+</span> <span class="va">N</span> <span class="op">-</span> <span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="va">samples_df</span> <span class="op">&lt;-</span> <span class="fu">data.frame</span><span class="op">(</span>prior <span class="op">=</span> <span class="va">prior_samples</span>, </span>
<span>                         posterior <span class="op">=</span> <span class="va">posterior_samples</span><span class="op">)</span></span></code></pre>
</div>
<p>Letâs plot histograms for these samples along with the analytical
densities, the normalized likelihood, and the âtrueâ value (blue) based
on a larger population sample.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Wide --&gt; long format</span></span>
<span><span class="va">samples_df_w</span> <span class="op">&lt;-</span> <span class="va">samples_df</span> <span class="op">%&gt;%</span> <span class="fu">gather</span><span class="op">(</span>key <span class="op">=</span> <span class="st">"Samples"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define analytical distributions</span></span>
<span><span class="va">delta</span> <span class="op">&lt;-</span> <span class="fl">0.001</span></span>
<span><span class="va">analytical_df</span> <span class="op">&lt;-</span> <span class="fu">data.frame</span><span class="op">(</span>p <span class="op">=</span> <span class="fu">seq</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="va">delta</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    prior <span class="op">=</span> <span class="fu">dbeta</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span> , <span class="va">alpha</span>, <span class="va">beta</span><span class="op">)</span>, </span>
<span>    posterior <span class="op">=</span> <span class="fu">dbeta</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span> , <span class="va">alpha</span> <span class="op">+</span> <span class="va">x</span>, <span class="va">beta</span> <span class="op">+</span> <span class="va">N</span> <span class="op">-</span> <span class="va">x</span><span class="op">)</span>, </span>
<span>    likelihood <span class="op">=</span> <span class="fu">dbinom</span><span class="op">(</span>size <span class="op">=</span> <span class="va">N</span>, x <span class="op">=</span> <span class="va">x</span>, prob <span class="op">=</span> <span class="va">p</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>likelihood <span class="op">=</span> <span class="va">likelihood</span><span class="op">/</span><span class="op">(</span><span class="fu">sum</span><span class="op">(</span><span class="va">likelihood</span><span class="op">)</span><span class="op">*</span><span class="va">delta</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># normalize likelihood for better presentation</span></span>
<span>  <span class="fu">gather</span><span class="op">(</span>key <span class="op">=</span> <span class="st">"Analytical function"</span>, value <span class="op">=</span> <span class="st">"value"</span>, <span class="op">-</span><span class="va">p</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># wide --&gt; long</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>`Analytical function` <span class="op">=</span> <span class="fu">factor</span><span class="op">(</span><span class="va">`Analytical function`</span>, levels <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"posterior"</span>, <span class="st">"prior"</span>, <span class="st">"likelihood"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Frequency in a large population sample (Hardyck, C. et al., 1976)</span></span>
<span><span class="va">p_true</span> <span class="op">&lt;-</span> <span class="fl">9.6</span><span class="op">/</span><span class="fl">100</span></span>
<span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">samples_df_w</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, y <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="va">density</span><span class="op">)</span>,</span>
<span>                     fill <span class="op">=</span> <span class="va">Samples</span><span class="op">)</span>,</span>
<span>                 bins <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                 position <span class="op">=</span> <span class="st">"identity"</span>, alpha <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>data <span class="op">=</span> <span class="va">analytical_df</span>, </span>
<span>            <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">`Analytical function`</span><span class="op">)</span>, </span>
<span>            linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">p_true</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"blue"</span>, </span>
<span>             linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_grafify</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_grafify</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"p"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">print</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="../fig/sampling-rendered-unnamed-chunk-4-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>When sampling the prior and posterior, it is important to draw
sufficiently many samples to get an accurate representation of the true
density. Typically, this means drawing at least some thousands of
samples.</p>
</section><section id="predictive-distributions"><h2 class="section-heading">Predictive distributions<a class="anchor" aria-label="anchor" href="#predictive-distributions"></a>
</h2>
<hr class="half-width">
<p>The posterior distribution gives probabilities for the model
parameters conditional on the data which is information regarding the
data generative process. However, it can also be valuable to analyze
what sort of observations might be expected to arise if more data was
gathered. On the other hand this might be an interesting question to
address based simply on the prior beliefs.</p>
<p>The posterior and prior predictive distributions aim to address this
question. They give probabilities for new observations based on the
prior, model and currently available data. Prior predictions do not use
the data, however.</p>
<p>The prior predictive distribution (also known as marginal
distribution of data) is defined as</p>
<p><span class="math display">\[p(y) = \int p(\theta)p(y | \theta) d
\theta.\]</span></p>
<p>In this course, we will not be using the analytical formula or make
derivations for any models. The key point here is to be able to simulate
from <span class="math inline">\(p(y)\)</span>. This can be done by
first drawing a sample from the prior <span class="math inline">\(p(\theta)\)</span> and then using this sample to
generate data based on <span class="math inline">\(p(y |
\theta).\)</span> Letâs generate some data based on the Beta-binomial
model of the handedness example and plot a histogram of <span class="math inline">\(y.\)</span></p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="co"># Draw from the prior</span></span>
<span><span class="va">prior_samples2</span> <span class="op">&lt;-</span> <span class="fu">rbeta</span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>                        shape1 <span class="op">=</span> <span class="va">a</span>,</span>
<span>                        shape2 <span class="op">=</span> <span class="va">b</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate data based on the prior samples</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">rbinom</span><span class="op">(</span><span class="va">n_samples</span>, size <span class="op">=</span> <span class="fl">50</span>, prob <span class="op">=</span> <span class="va">prior_samples2</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">p_y</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">data.frame</span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, </span>
<span>                 <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, </span>
<span>                 binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">print</span><span class="op">(</span><span class="va">p_y</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="../fig/sampling-rendered-unnamed-chunk-5-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="discussion1" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Discussion<a class="anchor" aria-label="anchor" href="#discussion1"></a>
</h3>
<div class="callout-content">
<p>Discuss the logic of the sampling process.</p>
<p>What does the distribution tell you?</p>
<p>In the example above, we used <code>size = 50</code>. What is the
significance of this and could we have used some other value?</p>
<p>Play around with different parameter values.</p>
</div>
</div>
</div>
<p>The posterior predictive distribution is defined as</p>
<p><span class="math display">\[p(\tilde{y} | y) = \int p(\tilde{y} |
\theta)p(\theta | y) d \theta.\]</span></p>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge2"></a>
</h3>
<div class="callout-content">
<p>How do you generate samples from the posterior predictive
distribution <span class="math inline">\(p(\tilde{y} | y)\)</span></p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>The posterior predictive distribution can be samples as follows:</p>
<ol style="list-style-type: decimal">
<li>Draw sample from the posterior <span class="math inline">\(p(\theta
| y)\)</span>
</li>
<li>Generate observations based on <span class="math inline">\(p(\tilde{y} | \theta)\)</span>
</li>
</ol>
</div>
</div>
</div>
</div>
<p>Letâs simulate the posterior predictive distribution.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">7</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="va">posterior_samples2</span> <span class="op">&lt;-</span> <span class="fu">rbeta</span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_samples</span>,</span>
<span>                           shape1 <span class="op">=</span> <span class="va">a</span> <span class="op">+</span> <span class="va">x</span>, </span>
<span>                           shape2 <span class="op">=</span> <span class="va">b</span> <span class="op">+</span> <span class="va">N</span> <span class="op">-</span> <span class="va">x</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Generate data based on the prior samples</span></span>
<span><span class="va">y_tilde</span> <span class="op">&lt;-</span> <span class="fu">rbinom</span><span class="op">(</span><span class="va">n_samples</span>, size <span class="op">=</span> <span class="fl">50</span>, prob <span class="op">=</span> <span class="va">posterior_samples2</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">p_y_tilde</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">data.frame</span><span class="op">(</span><span class="va">y_tilde</span><span class="op">)</span>, </span>
<span>                 <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">y_tilde</span><span class="op">)</span>, </span>
<span>                 binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">print</span><span class="op">(</span><span class="va">p_y_tilde</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="../fig/sampling-rendered-unnamed-chunk-6-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure></section><section id="posterior-intervals"><h2 class="section-heading">Posterior intervals<a class="anchor" aria-label="anchor" href="#posterior-intervals"></a>
</h2>
<hr class="half-width">
<p>In Episode 1, we summarized the posterior with the posterior mode
(MAP), mean and variance. While these points estimates are informative
and often utilized, they and not informative enough for many
scenarios.</p>
<p>More specified information about the posterior can be communicated
with <em>credible intervals</em> (CI). These intervals refer to areas of
the space where a certain amount of posterior mass is located. Usually
CIs are computed as quantiles of posterior, so for instance the 90% CI
would be located between the 5% and 95% percentiles.</p>
<p>Let us now compute the percentile-based CIs for the handedness
example, along with the posterior mode (MAP), and include them in the
figure. The x-axis is zoomed so for clarity.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># MAP</span></span>
<span><span class="va">posterior_density</span> <span class="op">&lt;-</span> <span class="fu">density</span><span class="op">(</span><span class="va">posterior_samples</span><span class="op">)</span></span>
<span><span class="va">MAP</span> <span class="op">&lt;-</span> <span class="va">posterior_density</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="fu">which.max</span><span class="op">(</span><span class="va">posterior_density</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># 90% credible interval</span></span>
<span><span class="va">CIs</span> <span class="op">&lt;-</span> <span class="fu">quantile</span><span class="op">(</span><span class="va">posterior_samples</span>, probs <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">CIs</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">MAP</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">p_true</span>, color <span class="op">=</span> <span class="st">"blue"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Black = MAP and 90% CIs"</span><span class="op">)</span> </span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">WARNING<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="warning" tabindex="0"><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
â¹ Please use `linewidth` instead.
This warning is displayed once every 8 hours.
Call `lifecycle::last_lifecycle_warnings()` to see where this warning was
generated.</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">print</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="../fig/sampling-rendered-unnamed-chunk-7-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>The 90% interval in this example is 0.07, 0.21 which means that,
according to the analysis, there is a 90% probability that the
proportion of left-handed people is between these values.</p>
<p>Another approach to reporting posterior information is to find the
amount of the posterior mass in a given interval (or some more general
set). This approach enables determining probabilities for hypotheses.
For instance, we might be interested in knowing the probability that the
target parameter is less than 0.2, between 0.05 and 0.10, or less than
0.1 or greater than 0.20. Such probabilities can be recovered based on
samples simply by computing the proportion of samples in these sets.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_less_than_0.15</span> <span class="op">&lt;-</span> <span class="fu">mean</span><span class="op">(</span><span class="va">posterior_samples</span> <span class="op">&lt;</span> <span class="fl">0.15</span><span class="op">)</span></span>
<span><span class="va">p_between_0.05_0.1</span> <span class="op">&lt;-</span> <span class="fu">mean</span><span class="op">(</span><span class="va">posterior_samples</span> <span class="op">&gt;</span> <span class="fl">0.05</span> <span class="op">&amp;</span> <span class="va">posterior_samples</span> <span class="op">&lt;</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">p_outside_0.1_0.2</span> <span class="op">&lt;-</span> <span class="fu">mean</span><span class="op">(</span><span class="va">posterior_samples</span> <span class="op">&lt;</span> <span class="fl">0.1</span> <span class="op">|</span> <span class="va">posterior_samples</span> <span class="op">&gt;</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre>
</div>
<div id="discussion2" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Discussion<a class="anchor" aria-label="anchor" href="#discussion2"></a>
</h3>
<div class="callout-content">
<p>What is the logic behind taking the average when computing the
probabilities for different values for the parameter?</p>
</div>
</div>
</div>
<p>Letâs visualize these probabilities as shaded areas of the analytical
posterior:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_df</span> <span class="op">&lt;-</span> <span class="va">analytical_df</span> <span class="op">%&gt;%</span> </span>
<span>                 <span class="fu">filter</span><span class="op">(</span><span class="va">`Analytical function`</span> <span class="op">==</span> <span class="st">"posterior"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">my_df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span>, y <span class="op">=</span> <span class="va">value</span>,</span>
<span>                     color <span class="op">=</span> <span class="va">`Analytical function`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">scale_color_grafify</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_breaks</span> <span class="op">&lt;-</span> <span class="fu">seq</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">my_p</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_area</span><span class="op">(</span>data <span class="op">=</span> <span class="va">my_df</span> <span class="op">%&gt;%</span> </span>
<span>              <span class="fu">filter</span><span class="op">(</span><span class="va">p</span> <span class="op">&lt;=</span> <span class="fl">0.15</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>              <span class="fu">mutate</span><span class="op">(</span>area <span class="op">=</span> <span class="st">"yes"</span><span class="op">)</span>, </span>
<span>            <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span>, y <span class="op">=</span> <span class="va">value</span>,</span>
<span>                     color <span class="op">=</span> <span class="va">`Analytical function`</span><span class="op">)</span>, </span>
<span>            alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co"># scale_x_continuous(breaks = c(my_breaks, 0.2)) +</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu">paste0</span><span class="op">(</span><span class="st">"P(p &lt; 0.15) = "</span>, <span class="fu">round</span><span class="op">(</span><span class="va">p_less_than_0.15</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">my_p</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_area</span><span class="op">(</span>data <span class="op">=</span> <span class="va">my_df</span> <span class="op">%&gt;%</span> </span>
<span>              <span class="fu">filter</span><span class="op">(</span><span class="va">p</span> <span class="op">&lt;=</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="va">p</span> <span class="op">&gt;=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>              <span class="fu">mutate</span><span class="op">(</span>area <span class="op">=</span> <span class="st">"yes"</span><span class="op">)</span>, </span>
<span>            <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span>, y <span class="op">=</span> <span class="va">value</span>,</span>
<span>                     color <span class="op">=</span> <span class="va">`Analytical function`</span><span class="op">)</span>, </span>
<span>            alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu">paste0</span><span class="op">(</span><span class="st">"P(0.05 &lt; p &lt; 0.1) = "</span>, <span class="fu">round</span><span class="op">(</span><span class="va">p_between_0.05_0.1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="va">my_p</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_area</span><span class="op">(</span>data <span class="op">=</span> <span class="va">my_df</span> <span class="op">%&gt;%</span> </span>
<span>              <span class="fu">filter</span><span class="op">(</span><span class="va">p</span> <span class="op">&gt;=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>              <span class="fu">mutate</span><span class="op">(</span>area <span class="op">=</span> <span class="st">"yes"</span><span class="op">)</span>, </span>
<span>            <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span>, y <span class="op">=</span> <span class="va">value</span>,</span>
<span>                     color <span class="op">=</span> <span class="va">`Analytical function`</span><span class="op">)</span>, </span>
<span>            alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_area</span><span class="op">(</span>data <span class="op">=</span> <span class="va">my_df</span> <span class="op">%&gt;%</span> </span>
<span>              <span class="fu">filter</span><span class="op">(</span><span class="va">p</span> <span class="op">&lt;=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>              <span class="fu">mutate</span><span class="op">(</span>area <span class="op">=</span> <span class="st">"yes"</span><span class="op">)</span>, </span>
<span>            <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span>, y <span class="op">=</span> <span class="va">value</span>,</span>
<span>                     color <span class="op">=</span> <span class="va">`Analytical function`</span><span class="op">)</span>, </span>
<span>            alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu">paste0</span><span class="op">(</span><span class="st">"P(p &lt; 0.1 or p &gt; 0.2) = "</span>, <span class="fu">round</span><span class="op">(</span><span class="va">p_outside_0.1_0.2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">p_area</span> <span class="op">&lt;-</span> <span class="fu">plot_grid</span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span>,</span>
<span>               ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">print</span><span class="op">(</span><span class="va">p_area</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="../fig/sampling-rendered-unnamed-chunk-9-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="discussion3" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Discussion<a class="anchor" aria-label="anchor" href="#discussion3"></a>
</h3>
<div class="callout-content">
<p>How would you compute CIs based on an analytical posterior
density?</p>
<p>Can you draw samples from the likelihood?</p>
</div>
</div>
</div>
<div id="challenge3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge3"></a>
</h3>
<div class="callout-content">
<p>Another approach to posterior summarizing to compute the smallest
interval that contains p% of the posterior. Such sets are called highest
posterior density intervals (HPDI). More generally, this set can be a
more general set than an interval.</p>
<p>Write a function that returns the highest posterior density interval
based on a set of posterior samples. Compute the 95% HPDI for the
posterior samples generated (<code>samples_df</code>) and compare it to
the 95% CIs.</p>
</div>
</div>
</div>
<div id="accordionHint1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button hint-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHint1" aria-expanded="false" aria-controls="collapseHint1">
  <h4 class="accordion-header" id="headingHint1">
  Give me a hint
  </h4>
</button>
<div id="collapseHint1" class="accordion-collapse collapse" aria-labelledby="headingHint1" data-bs-parent="#accordionHint1">
<div class="accordion-body">
<p>If you sort the posterior samples in order, each set of <span class="math inline">\(n\)</span> consecutive samples contains <span class="math inline">\(100 \cdot n/N \%\)</span> of the posterior, where
<span class="math inline">\(N\)</span> is the total number of
samples.</p>
</div>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<p>Letâs write the function for computing the HPDI</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_HPDI</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">samples</span>, <span class="va">prob</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Total samples</span></span>
<span>  <span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fu">length</span><span class="op">(</span><span class="va">samples</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># How many samples constitute prob of the total number?</span></span>
<span>  <span class="va">prob_samples</span> <span class="op">&lt;-</span> <span class="fu">round</span><span class="op">(</span><span class="va">prob</span><span class="op">*</span><span class="va">n_samples</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Sort samples</span></span>
<span>  <span class="va">samples_sort</span> <span class="op">&lt;-</span> <span class="va">samples</span> <span class="op">%&gt;%</span> <span class="va">sort</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># Each samples_sort[i:(i + prob_samples - 1)] contains prob of the total distribution mass</span></span>
<span>  <span class="co"># Find the shortest such interval </span></span>
<span>  <span class="va">min_i</span> <span class="op">&lt;-</span> <span class="fu">lapply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n_samples</span> <span class="op">-</span> <span class="va">prob_samples</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">samples_sort</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="va">prob_samples</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">samples_sort</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">unlist</span> <span class="op">%&gt;%</span> <span class="fu">which.min</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Get correspongind values</span></span>
<span>  <span class="va">hpdi</span> <span class="op">&lt;-</span> <span class="va">samples_sort</span><span class="op">[</span><span class="fu">c</span><span class="op">(</span><span class="va">min_i</span>, <span class="va">min_i</span> <span class="op">+</span> <span class="va">prob_samples</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw">return</span><span class="op">(</span><span class="va">hpdi</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre>
</div>
<p>Then we can compute the 95% HPDI and compare it to the corresponding
CIs</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">data.frame</span><span class="op">(</span>HPDI <span class="op">=</span> <span class="fu">get_HPDI</span><span class="op">(</span><span class="va">samples_df</span><span class="op">$</span><span class="va">posterior</span>, <span class="fl">0.95</span><span class="op">)</span>, </span>
<span>           CI <span class="op">=</span> <span class="fu">quantile</span><span class="op">(</span><span class="va">posterior_samples</span>, probs <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="va">t</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">data.frame</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>length <span class="op">=</span> <span class="va">X97.5.</span> <span class="op">-</span> <span class="va">X2.5.</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>          X2.5.    X97.5.    length
HPDI 0.05238917 0.2166172 0.1642280
CI   0.05780546 0.2281867 0.1703812</code></pre>
</div>
<p>Both intervals contain the same mass but the HPDI is (slightly)
shorter.</p>
<p>The code of the solution is based on the HPDI implementation of the
function <code>coda::HPDinterval</code></p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Being able to sample from distributions make working with Bayesian
models a lot more straight-forward</li>
<li>Prior/posterior predictive distributions describe the type of data
weâd expect to encounter based on prior/posterior information.</li>
<li>The posterior distribution can be summarized with point estimates or
computing the posterior mass in some set.</li>
<li>The credible intervals can be computed based on samples using
posterior quantiles</li>
<li>Probability of a parameter being in a set can be computed as the
proportion of samples within the particular set.</li>
</ul>
</div>
</div>
</div>
</section><section id="reading"><h2 class="section-heading">Reading<a class="anchor" aria-label="anchor" href="#reading"></a>
</h2>
<hr class="half-width">
<ul>
<li>Gelman <em>et al.</em>, Bayesian Data Analysis (3rd ed.):
<ul>
<li>p.Â 7: Prediction</li>
<li>p.Â 23: Simulation of posterior and â¦</li>
</ul>
</li>
<li>McElreath, Statistical Rethinking (2nd ed.): Ch. 3</li>
</ul>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 --></section></section><section id="aio-stan"><p>Content from <a href="stan.html">Stan</a></p>
<hr>
<p> Last updated on 2023-06-27 | 
        
        <a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/edit/main/episodes/stan.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is Stan?</li>
<li>How to efficiently generate samples from a posterior?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Install Stan and get it running</li>
<li>Learn how to specify models in Stan</li>
<li>How to generate samples with Stan</li>
<li>How to process samples generated with Stan</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Stan is a high-level programming language that can be used for
sampling from the posterior distribution of a statistical model. It
provides a flexible and efficient means the for inference of Bayesian
models. Stan generates samples from the posterior of a defined
statistical model utilizing Markov Chain Monte Carlo (MCMC) sampling,
and more specifically its the Hamiltonian Monte Carlo variant which is a
highly effective variant of MCMC.</p>
<p>Follow the instruction at <a href="https://mc-stan.org/users/interfaces/" class="external-link uri">https://mc-stan.org/users/interfaces/</a> to install Stan on
your local computer.</p>
<section id="basic-program-structure"><h2 class="section-heading">Basic program structure<a class="anchor" aria-label="anchor" href="#basic-program-structure"></a>
</h2>
<hr class="half-width">
<ul>
<li><p>Write the program in a separate text file</p></li>
<li><p>Call Stan from R, command line, or several other languages. This
creates a collection of posterior samples.</p></li>
<li><p>Analyse the posterior samples with tools presented in the
previous episode.</p></li>
</ul>
<p>Next, letâs write the models we have previously worked with in
Stan.</p>
</section><section id="example-1-binomial-model"><h2 class="section-heading">Example 1: Binomial model<a class="anchor" aria-label="anchor" href="#example-1-binomial-model"></a>
</h2>
<hr class="half-width">
<p>A Stan program is structured into several blocks that define the
statistical model and specify the algorithm for inference. A Stan
program typically (but not necessarily) includes the following
blocks:</p>
<ol style="list-style-type: decimal">
<li><p>Data block: This block is used to declare the input data fed into
the model. It specifies the types and dimensions of the data variables
used in the model.</p></li>
<li><p>Parameters block: In this block, the modelâs parameters, that are
inferred, are declared.</p></li>
<li><p>Model block: The model block contains the specification of the
statistical model, consisting of the likelihood and the prior
distributions.</p></li>
</ol>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">STAN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode stan" tabindex="0"><code class="sourceCode stan"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">data</span>{</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N; </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; x; </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">parameters</span>{</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>, <span class="kw">upper</span>=<span class="dv">1</span>&gt; p;</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span>{</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Likelihood</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    x ~ binomial(N, p);</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Uniform prior for p</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre>
</div>
<p>Notice that the types of each data variable and parameter needs to be
specified. Moreover, it is helpful to specify the ranges the variables
can get. For example, a variable that can only get positive values can
be specified with a <code>&lt;lower=0&gt;</code> after the type
specification.</p>
<p>The sampling statement <code>x ~ binomial(N, p);</code> in the model
block defines that the likelihood for the data is the binomial
distribution. No prior distribution is specified for the parameter <span class="math inline">\(p\)</span> which implicitly imposes a uniform
distribution.</p>
<p>Next, letâs define the data as a list and then call the Stan
program.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">binom_data</span> <span class="op">&lt;-</span> <span class="fu">list</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">50</span>, x <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span></span>
<span><span class="va">binom_samples</span> <span class="op">&lt;-</span> <span class="fu">sampling</span><span class="op">(</span><span class="va">binomial_model</span>, <span class="va">binom_data</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>
SAMPLING FOR MODEL 'b30a4b20165ba5a239ed8d361ba485d2' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 1.1e-05 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.11 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 0.008811 seconds (Warm-up)
Chain 1:                0.008749 seconds (Sampling)
Chain 1:                0.01756 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'b30a4b20165ba5a239ed8d361ba485d2' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 5e-06 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.05 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 0.008863 seconds (Warm-up)
Chain 2:                0.007381 seconds (Sampling)
Chain 2:                0.016244 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'b30a4b20165ba5a239ed8d361ba485d2' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 4e-06 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 0.008069 seconds (Warm-up)
Chain 3:                0.008544 seconds (Sampling)
Chain 3:                0.016613 seconds (Total)
Chain 3: 

SAMPLING FOR MODEL 'b30a4b20165ba5a239ed8d361ba485d2' NOW (CHAIN 4).
Chain 4: 
Chain 4: Gradient evaluation took 4e-06 seconds
Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.
Chain 4: Adjust your expectations accordingly!
Chain 4: 
Chain 4: 
Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 4: 
Chain 4:  Elapsed Time: 0.008079 seconds (Warm-up)
Chain 4:                0.007107 seconds (Sampling)
Chain 4:                0.015186 seconds (Total)
Chain 4: </code></pre>
</div>
<p>With the default setting Stan runs 4 MCMC chains with 2000 iterations
(more about this in Episode 5 on MCMC). Running
<code>binom_samples</code> prints a posterior summary for the model
parameter <span class="math inline">\(p\)</span> that allows you to
quickly review the results.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">binom_samples</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Inference for Stan model: b30a4b20165ba5a239ed8d361ba485d2.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

       mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
p      0.15    0.00 0.05   0.07   0.12   0.15   0.18   0.26  1626    1
lp__ -22.82    0.02 0.72 -24.87 -22.97 -22.55 -22.38 -22.33  1465    1

Samples were drawn using NUTS(diag_e) at Tue Jun 27 01:07:43 2023.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
<p>This summary can also be accessed as a matrix with
<code>summary(binom_samples)$summary</code>.</p>
<p>Often, however, it is necessary to work with the individual samples.
These can be extracted as follows:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_samples</span> <span class="op">&lt;-</span> <span class="fu">extract</span><span class="op">(</span><span class="va">binom_samples</span>, <span class="st">"p"</span><span class="op">)</span><span class="op">[[</span><span class="st">"p"</span><span class="op">]</span><span class="op">]</span></span></code></pre>
</div>
<p>Now we can use the methods presented in the previous Episode to
compute posterior summaries, credible intervals and to generate
figures.</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>(Revision)</p>
<p>Compute the 95% credible intervals for the samples drawn with Stan.
What is the probability that <span class="math inline">\(p \in [0.05,
0.15]\)</span>? Plot a histogram of the posterior samples.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CI95</span> <span class="op">&lt;-</span> <span class="fu">quantile</span><span class="op">(</span><span class="va">p_samples</span>, probs <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p_between_0.05_0.15</span> <span class="op">&lt;-</span> <span class="fu">mean</span><span class="op">(</span><span class="va">p_samples</span><span class="op">&gt;</span><span class="fl">0.05</span> <span class="op">&amp;</span> <span class="va">p_samples</span><span class="op">&lt;</span><span class="fl">0.15</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">data.frame</span><span class="op">(</span>p <span class="op">=</span> <span class="va">p_samples</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span><span class="op">)</span>, bins <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">print</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="../fig/stan-rendered-unnamed-chunk-6-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge2"></a>
</h3>
<div class="callout-content">
<p>It recommended that the Stan program is specified in a separate text
file that is then called from R. Copy the binomial model from above into
a text file and save it as <code>binomial.stan</code>. Then call it from
R with <code>binomial_model &lt;- stan_model("binomial.stan")</code> and
generate samples with
<code>rstan::sampling(binomial_model, stan_data)</code>.</p>
<p>Try setting a <span class="math inline">\(Beta\)</span> prior for
p.Â </p>
<p>Can you modify the Stan program further so that you can set the
hyperparameters <span class="math inline">\(\alpha, \beta\)</span> as
part of the data? What is the benefit of using this approach?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>If the data block is modified so that it declares the hyperparameters
as data (e.g.Â <code>real&lt;lower=0&gt; alpha;</code>), it enables
setting the hyperparameter values as part of data. This way several
hyperparameters can be tried out quickly, without modifying the Stan
file.</p>
</div>
</div>
</div>
</div>
<p>Letâs use this Stan program to fit the handedness data encountered in
the previous episodes.</p>
</section><section id="example-2-normal-model"><h2 class="section-heading">Example 2: normal model<a class="anchor" aria-label="anchor" href="#example-2-normal-model"></a>
</h2>
<hr class="half-width">
<p>Next, letâs implement the normal model in Stan. First generate some
data with unknown mean and standard deviation parameters <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span></p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sample size</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">99</span></span>
<span></span>
<span><span class="co"># Generate data with unknown parameters</span></span>
<span><span class="va">unknown_sigma</span> <span class="op">&lt;-</span> <span class="fu">runif</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">unknown_mu</span> <span class="op">&lt;-</span> <span class="fu">runif</span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu">rnorm</span><span class="op">(</span>n <span class="op">=</span> <span class="va">N</span>,</span>
<span>           mean <span class="op">=</span> <span class="va">unknown_mu</span>,</span>
<span>           sd <span class="op">=</span> <span class="va">unknown_sigma</span><span class="op">)</span> </span></code></pre>
</div>
<p>Then the stan program, which the following piece of code stores as
<code>normal_model</code>.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">STAN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode stan" tabindex="0"><code class="sourceCode stan"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] X;</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> mu;</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// likelihood is vectorized!</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  X ~ normal(mu, sigma);</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  mu ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  sigma ~ gamma(<span class="dv">2</span>, <span class="dv">1</span>);</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
</div>
<p>Notice that the likelihood in the model block is vectorized.
Alternatively, one could write a for loop that samples each data point
individually from the likelihood:
<code>X[i] ~normal(\mu, \sigma)</code>. This would be an inefficient way
of implementing the likelihood function and vectorization is
recommended. However, when writing complex models it may be useful to
initially write the model in an unvectorized format so debugging is
easier.</p>
<p>Letâs again fit the model on the data</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Call Stan</span></span>
<span><span class="va">normal_samples</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu">sampling</span><span class="op">(</span><span class="va">normal_model</span>, </span>
<span>                                  <span class="fu">list</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N</span>, X <span class="op">=</span> <span class="va">X</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>
SAMPLING FOR MODEL 'ce5e697fa501eb08497df31f1fdce3a0' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 1.1e-05 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.11 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 0.014417 seconds (Warm-up)
Chain 1:                0.012895 seconds (Sampling)
Chain 1:                0.027312 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'ce5e697fa501eb08497df31f1fdce3a0' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 4e-06 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 0.014441 seconds (Warm-up)
Chain 2:                0.010089 seconds (Sampling)
Chain 2:                0.02453 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'ce5e697fa501eb08497df31f1fdce3a0' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 5e-06 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.05 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 0.01535 seconds (Warm-up)
Chain 3:                0.013844 seconds (Sampling)
Chain 3:                0.029194 seconds (Total)
Chain 3: 

SAMPLING FOR MODEL 'ce5e697fa501eb08497df31f1fdce3a0' NOW (CHAIN 4).
Chain 4: 
Chain 4: Gradient evaluation took 4e-06 seconds
Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.
Chain 4: Adjust your expectations accordingly!
Chain 4: 
Chain 4: 
Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 4: 
Chain 4:  Elapsed Time: 0.014156 seconds (Warm-up)
Chain 4:                0.009893 seconds (Sampling)
Chain 4:                0.024049 seconds (Total)
Chain 4: </code></pre>
</div>
<p>and plot the posterior</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract parameter samples</span></span>
<span><span class="va">par_samples</span> <span class="op">&lt;-</span> <span class="fu">extract</span><span class="op">(</span><span class="va">normal_samples</span>, <span class="fu">c</span><span class="op">(</span><span class="st">"mu"</span>, <span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">do.call</span><span class="op">(</span><span class="va">cbind</span>, <span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="va">data.frame</span></span>
<span></span>
<span></span>
<span><span class="co"># Full posterior</span></span>
<span><span class="va">p_posterior</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">par_samples</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mu</span>, y <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">unknown_mu</span>, y <span class="op">=</span> <span class="va">unknown_sigma</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"red"</span>, size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Marginal posteriors</span></span>
<span><span class="va">p_marginals</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">par_samples</span> <span class="op">%&gt;%</span> <span class="va">gather</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, bins <span class="op">=</span> <span class="fl">40</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">data.frame</span><span class="op">(</span>key <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"mu"</span>, <span class="st">"sigma"</span><span class="op">)</span>, </span>
<span>                               value <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="va">unknown_mu</span>, <span class="va">unknown_sigma</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             <span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">key</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu">plot_grid</span><span class="op">(</span><span class="va">p_posterior</span>, <span class="va">p_marginals</span>,</span>
<span>                  ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">print</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="../fig/stan-rendered-unnamed-chunk-10-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure></section><section id="example-3-linear-regression"><h2 class="section-heading">Example 3: Linear regression<a class="anchor" aria-label="anchor" href="#example-3-linear-regression"></a>
</h2>
<hr class="half-width">
<div id="challenge3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge3"></a>
</h3>
<div class="callout-content">
<p>Write a Stan program for linear regression with one dependent
variable.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">STAN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode stan" tabindex="0"><code class="sourceCode stan"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N; <span class="co">// Sample size</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] x; <span class="co">// x-values</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] y; <span class="co">// y-values</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha; <span class="co">// intercept</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> beta;  <span class="co">// slope</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma; <span class="co">// noise</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Likelihood</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  y ~ normal(alpha + beta * x, sigma);</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  alpha ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  beta ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  sigma ~ gamma(<span class="dv">2</span>, <span class="dv">1</span>);</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="challenge4" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge4"></a>
</h3>
<div class="callout-content">
<p>Write a Stan program for linear regression with <span class="math inline">\(M\)</span> dependent variables.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">STAN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode stan" tabindex="0"><code class="sourceCode stan"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N; <span class="co">// Sample size</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; M; <span class="co">// Number of features</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N, M] x; <span class="co">// x-values</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] y; <span class="co">// y-values</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha; <span class="co">// intercept</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[M] beta;  <span class="co">// slopes</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma; <span class="co">// noise</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Likelihood</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  y ~ normal(alpha + x * beta, sigma);</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  alpha ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  beta ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  sigma ~ gamma(<span class="dv">2</span>, <span class="dv">1</span>);</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="callout1" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout1"></a>
</h3>
<div class="callout-content">
<ul>
<li><p>With Stan, you can fit model that have continuous parameters.
Models with discrete parameters such as most classification models are
typically impossible to fit, although some workarounds have been
implemented.</p></li>
<li><p>Bayesplot, rstanarm, brms</p></li>
</ul>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Stan isâ¦</li>
</ul>
</div>
</div>
</div>
</section><section id="reading"><h2 class="section-heading">Reading<a class="anchor" aria-label="anchor" href="#reading"></a>
</h2>
<hr class="half-width">
<ul>
<li>Installation guide: <a href="https://mc-stan.org/users/interfaces/" class="external-link uri">https://mc-stan.org/users/interfaces/</a>
</li>
<li>Userâs manual: <a href="https://mc-stan.org/docs/stan-users-guide/index.html" class="external-link uri">https://mc-stan.org/docs/stan-users-guide/index.html</a>
</li>
<li>Bayes Rules!: Chp. 6.2 <a href="https://www.bayesrulesbook.com/chapter-6.html#markov-chains-via-rstan" class="external-link uri">https://www.bayesrulesbook.com/chapter-6.html#markov-chains-via-rstan</a>
</li>
</ul>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 --></section></section><section id="aio-mcmc"><p>Content from <a href="mcmc.html">MCMC</a></p>
<hr>
<p> Last updated on 2023-06-27 | 
        
        <a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/edit/main/episodes/mcmc.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is MCMC?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li><p>Idea behind MCMC</p></li>
<li>
<p>Learn how to</p>
<ul>
<li>assess convergence</li>
<li>implement MCMC</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="basic-idea"><h2 class="section-heading">Basic idea<a class="anchor" aria-label="anchor" href="#basic-idea"></a>
</h2>
<hr class="half-width"></section><section id="example-variants"><h2 class="section-heading">Example variants<a class="anchor" aria-label="anchor" href="#example-variants"></a>
</h2>
<hr class="half-width"></section><section id="mcmc-diagnostics"><h2 class="section-heading">MCMC diagnostics<a class="anchor" aria-label="anchor" href="#mcmc-diagnostics"></a>
</h2>
<hr class="half-width"></section><section id="examples"><h2 class="section-heading">Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h2>
<hr class="half-width">
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>point 1</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-hierarchical-models"><p>Content from <a href="hierarchical-models.html">Hierarchical Models</a></p>
<hr>
<p> Last updated on 2023-06-27 | 
        
        <a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/edit/main/episodes/hierarchical-models.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What are Bayesian hierarchical models?</li>
<li>What are they good for?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand the idea of hierarchical models</li>
<li>Learn how to build and with hierarchical models with Stan</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="callout1" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout1"></a>
</h3>
<div class="callout-content">
<p>TODO: shrinkage</p>
</div>
</div>
</div>
<section id="hierachical-models"><h2 class="section-heading">Hierachical models<a class="anchor" aria-label="anchor" href="#hierachical-models"></a>
</h2>
<hr class="half-width">
<p>Bayesian hierarchical models are a class of models suited for
modeling scenarios where the study population consists of separate but
related groups. Hierarchical structure refers to this organization of
data into multiple levels or groups, where each level can have its own
set of parameters. These parameters are connected trough a common prior
that is also learned when fitting the model. Some or all of the
hyperparameters of the priors are unknown model parameters and they are
given hyperpriors.</p>
<p>One key advantage of Bayesian hierarchical models is their ability to
borrow strength across groups. By pooling information from multiple
groups, these models can provide more stable estimates, especially when
individual groups have limited data. This pooling of information is
particularly beneficial when there are sparse observations or when data
from different groups exhibit similar patterns.</p>
<p>Examples of scenarios where hierarchical model could be a natural
choice:</p>
</section><section id="example-hierarchical-binomial-model"><h2 class="section-heading">Example: Hierarchical binomial model<a class="anchor" aria-label="anchor" href="#example-hierarchical-binomial-model"></a>
</h2>
<hr class="half-width">
<p>Letâs take a look at a hierarchical binomial model. Let <span class="math inline">\(X = \{X_1, X_2, \ldots, X_N\}\)</span> be a set of
observations representing the number of successes in <span class="math inline">\(n\)</span> Bernoulli trials in <span class="math inline">\(N\)</span> different scenarios. We assume that
these scenarios are not identical, so there are <span class="math inline">\(N\)</span> unknown probability parameters, <span class="math inline">\(p_1, p_2, \ldots, p_N\)</span>. This model can be
specified as follows.</p>
<p><span class="math display">\[\begin{align}
X_i &amp;\sim Binom(n, p_i) \\
p_i &amp;\sim Beta(\alpha, \beta) \\
\alpha, \beta &amp;\sim Gamma(2, 1).
\end{align}\]</span></p>
<p>The difference to the binomial model as used in the previous episodes
is that the parameters <span class="math inline">\(p_i\)</span> have a
prior with unknown hyperparameters <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta.\)</span> These hyperparameters are given a
<span class="math inline">\(Gamma\)</span> prior and learned in the
inference.</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Hierarchical models are also called partially pooled models in
contrast to unpooled and completely pooled models. The former mean that
the model parameters are assumed to be completely independent, while in
the latter type the (parallel) parameters are equal. Write the unpooled
and completely pooled variants of the hierarchical binomial model.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>Unpooled:</p>
<p><span class="math display">\[\begin{align}
X_i &amp;\sim Binom(n, p_i) \\
p_i &amp;\sim Beta(2, 2) \\
\end{align}\]</span></p>
<p>Completely pooled:</p>
<p><span class="math display">\[\begin{align}
X_i &amp;\sim Binom(n, p) \\
p &amp;\sim Beta(2, 2) \\
\end{align}\]</span></p>
</div>
</div>
</div>
</div>
<p>Letâs then implement the hierarchical, along with the unpooled and
completely pooled binomial model in Stan.</p>
<p>Hierarchical binomial model</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">STAN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode stan" tabindex="0"><code class="sourceCode stan"></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">sampling</span><span class="op">(</span><span class="va">hierarchical_binomial_model</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in sampling(hierarchical_binomial_model): could not find function "sampling"</code></pre>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>point 1</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-model-critisism"><p>Content from <a href="model-critisism.html">Model checking</a></p>
<hr>
<p> Last updated on 2023-06-27 | 
        
        <a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/edit/main/episodes/model-critisism.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is model checking?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Learn how assess model fit</li>
<li>Model checking</li>
<li>Information criteria: AIC, BIC, WAIC</li>
<li>Bayesian cross-validation</li>
<li>Posterior predictive check</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="body"><h2 class="section-heading">Body<a class="anchor" aria-label="anchor" href="#body"></a>
</h2>
<hr class="half-width">
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>point 1</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-other-topics"><p>Content from <a href="other-topics.html">Other topics</a></p>
<hr>
<p> Last updated on 2023-06-27 | 
        
        <a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/edit/main/episodes/other-topics.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is MCMC?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li><p>Idea behind MCMC</p></li>
<li>
<p>Learn how to</p>
<ul>
<li>assess convergence</li>
<li>implement MCMC</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="body"><h2 class="section-heading">Body<a class="anchor" aria-label="anchor" href="#body"></a>
</h2>
<hr class="half-width">
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>point 1</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-recommended-reading"><p>Content from <a href="recommended-reading.html">further-materials</a></p>
<hr>
<p> Last updated on 2023-06-27 | 
        
        <a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/edit/main/episodes/recommended-reading.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Where can I learn more about statistical and probabilistic
programming?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Provide links to other materials where learners can deepen their
skills in probabilistic programming.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="main"><h2 class="section-heading">Main<a class="anchor" aria-label="anchor" href="#main"></a>
</h2>
<hr class="half-width">
<ul>
<li>Gelman</li>
<li>Statistical Rethinking</li>
<li>Bayes Rules!</li>
</ul>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>There are loads of additional material available</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-exercises"><p>Content from <a href="exercises.html">exercises</a></p>
<hr>
<p> Last updated on 2023-06-27 | 
        
        <a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/edit/main/episodes/exercises.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I get routine in probabilistic programming?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<p>The purpose of this episode is to provide material for practicing
probabilistic programming. The exercises are listed approximately based
on the episode they refer to.</p>
</div>
</div>
</div>
</div>
</div>
<section id="bayesian-statistics"><h2 class="section-heading">Bayesian statistics<a class="anchor" aria-label="anchor" href="#bayesian-statistics"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="easy-explanation">(easy) Explanation<a class="anchor" aria-label="anchor" href="#easy-explanation"></a>
</h3>
<p>In your own words, explain the following concepts</p>
<ol style="list-style-type: decimal">
<li>Posterior distribution</li>
<li>Informative prior distribution</li>
<li>Grid approximation</li>
<li>Effect of prior when different amount of data is available</li>
<li>Marginal posterior distribution</li>
</ol>
</div>
<div class="section level3">
<h3 id="easy-formula-explanations">(easy) Formula explanations<a class="anchor" aria-label="anchor" href="#easy-formula-explanations"></a>
</h3>
<p>For the models described by the following formulas, come up with
realistic scenarios where the models could be used.</p>
<ol style="list-style-type: decimal">
<li><p><span class="math display">\[\begin{align}
y_i &amp; \sim Normal(\mu, \sigma) \\
\mu &amp; \sim Normal(0, 1) \\
\sigma &amp; \sim Exponential(1)
\end{align}\]</span></p></li>
<li><p><span class="math display">\[\begin{align}
y_i &amp; \sim Normal(\alpha + \beta x_i, \sigma) \\
\alpha &amp; \sim Normal(0, 10) \\
\beta &amp; \sim Normal(0, 1) \\
\sigma &amp; \sim Exponential(1)
\end{align}\]</span></p></li>
</ol>
<p>Formulate statistical models for the following scenarios. Give
rationalizations for the likelihood and priors.</p>
<ol style="list-style-type: decimal">
<li><p>A batch of 10000 avocados is shipped from South America to North
Europe. Youâd like to estimate the proportion of the batch that doesnât
get bad in transit.</p></li>
<li><p>A dart-throwing robot is poorly calibrated. Its throws produce a
dense, normally distributed cluster with an approximately identity
covariance matrix. However, the throws seems to veer down and left from
bullâs eye. You want the calibrate the robot based on a set of previous
throws.</p></li>
</ol>
<p>Provide examples not found in the course material.</p>
</div>
<div class="section level3">
<h3 id="easy-formula-explanations-2">(easy) Formula explanations 2<a class="anchor" aria-label="anchor" href="#easy-formula-explanations-2"></a>
</h3>
<p>What prior distributions would you use for the following parameters?
Justify your choices.</p>
<ol style="list-style-type: decimal">
<li>Life expectancy in the developed world</li>
<li>The probability of a successful 3 point basketball throw (for
yourself)</li>
<li>The regression coefficient for milage per liter of gas and car
weight</li>
<li>The waiting time for a government bureau helpline</li>
<li>The effect of national energy drink consumption on yearly
rainfall</li>
</ol>
</div>
<div class="section level3">
<h3 id="medium-analyze-grid-approximation">(medium) Analyze grid approximation<a class="anchor" aria-label="anchor" href="#medium-analyze-grid-approximation"></a>
</h3>
<p>In Cox regression, the risk for an event (such as the onset of a
disease) can be estimated based on follow-up data and background
variables at the beginning of the study. Assume the effect of a cancer
medicine is studied in control and treatment groups. The data frame
below gives the posterior distribution for the effect size <span class="math inline">\(\beta\)</span> of the medicine on survival
compared to the control group. What assumptions were made in the
analysis that most likely will produce incorrect conclusions about the
efficacy of the drug?</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">data.frame</span><span class="op">(</span></span>
<span>  beta <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="op">-</span><span class="fl">0.25</span>, <span class="op">-</span><span class="fl">0.219</span>, <span class="op">-</span><span class="fl">0.188</span>, <span class="op">-</span><span class="fl">0.156</span>, <span class="op">-</span><span class="fl">0.125</span>, <span class="op">-</span><span class="fl">0.094</span>, <span class="op">-</span><span class="fl">0.062</span>, <span class="op">-</span><span class="fl">0.031</span>, <span class="fl">0</span>, <span class="fl">0.031</span>, <span class="fl">0.062</span>, <span class="fl">0.094</span>, <span class="fl">0.125</span>, <span class="fl">0.156</span>, <span class="fl">0.188</span>, <span class="fl">0.219</span>, <span class="fl">0.25</span>, <span class="fl">0.281</span>, <span class="fl">0.312</span>, <span class="fl">0.344</span>, <span class="fl">0.375</span>, <span class="fl">0.406</span>, <span class="fl">0.438</span>, <span class="fl">0.469</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  posterior <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">1.052</span>, <span class="fl">1.478</span>, <span class="fl">2.025</span>, <span class="fl">2.707</span>, <span class="fl">3.533</span>, <span class="fl">4.498</span>, <span class="fl">5.59</span>, <span class="fl">6.779</span>, <span class="fl">8.023</span>, <span class="fl">9.266</span>, <span class="fl">10.444</span>, <span class="fl">11.487</span>, <span class="fl">12.33</span>, <span class="fl">12.915</span>, <span class="fl">13.202</span>, <span class="fl">13.17</span>, <span class="fl">12.821</span>, <span class="fl">12.18</span>, <span class="fl">11.293</span>, <span class="fl">10.217</span>, <span class="fl">9.021</span>, <span class="fl">7.773</span>, <span class="fl">6.536</span>, <span class="fl">5.363</span>, <span class="fl">4.295</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="medium-grid-approximation-for-the-linear-model">(medium) Grid approximation for the linear model<a class="anchor" aria-label="anchor" href="#medium-grid-approximation-for-the-linear-model"></a>
</h3>
<p>On the planet Neptunus, a ball is dropped from <span class="math inline">\(h=8\)</span> meters <span class="math inline">\(N=25\)</span> times and the falling time <span class="math inline">\(t\)</span> is measured for each drop. From
previous experiments, it is known that the measurement error is normally
distributed with standard deviation of 0.2. The measurement times are as
follows.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="fl">1.28</span>, <span class="fl">1.18</span>, <span class="fl">1.37</span>, <span class="fl">1.17</span>, <span class="fl">0.98</span>, <span class="fl">1.02</span>,</span>
<span>          <span class="fl">1.16</span>, <span class="fl">1.19</span>, <span class="fl">1.55</span>, <span class="fl">1.13</span>, <span class="fl">1.57</span>, <span class="fl">1.26</span>,</span>
<span>          <span class="fl">1.39</span>, <span class="fl">1.1</span>, <span class="fl">1.4</span>, <span class="fl">0.92</span>, <span class="fl">1.15</span>, <span class="fl">1.19</span>, <span class="fl">1.25</span>,</span>
<span>          <span class="fl">1.01</span>, <span class="fl">0.82</span>, <span class="fl">1.46</span>, <span class="fl">1.06</span>, <span class="fl">1.38</span>, <span class="fl">1.24</span><span class="op">)</span></span></code></pre>
</div>
<p>According to Newtonâs theory of gravity, <span class="math inline">\(h\)</span> and <span class="math inline">\(t\)</span> are connected via the relation of <span class="math inline">\(h = \frac{1}{2}gt^2\)</span>, where <span class="math inline">\(g\)</span> is the gravitational constant.</p>
<p>Implement the grid approximation for standard linear regression and
estimate <span class="math inline">\(g\)</span>. Give the posterior mode
and 90% CIs. Use some reasonable prior distribution.</p>
<div class="section level4">
<h4 id="hint">Hint<a class="anchor" aria-label="anchor" href="#hint"></a>
</h4>
<p>Solve formula <span class="math inline">\(h =
\frac{1}{2}gt^2\)</span> for <span class="math inline">\(t\)</span> so
the model error measures time measurement error. Further, do a parameter
transformation so the formula doesnât contain squares of variables.</p>
</div>
</div>
</section><section id="working-with-samples"><h2 class="section-heading">Working with samples<a class="anchor" aria-label="anchor" href="#working-with-samples"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="easy-sampling-the-posterior">(easy) Sampling the posterior<a class="anchor" aria-label="anchor" href="#easy-sampling-the-posterior"></a>
</h3>
<p>Assume we model the following observations <span class="math inline">\(X\)</span> with the exponential likelihood:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0.166</span>, <span class="fl">1.08</span>, <span class="fl">1.875</span>, <span class="fl">0.413</span>, <span class="fl">1.369</span>, <span class="fl">0.463</span>, <span class="fl">0.735</span>,</span>
<span>       <span class="fl">0.24</span>, <span class="fl">0.774</span>, <span class="fl">1.09</span>, <span class="fl">0.463</span>, <span class="fl">0.916</span>, <span class="fl">0.225</span>, <span class="fl">0.889</span>,</span>
<span>       <span class="fl">0.051</span>, <span class="fl">0.688</span>, <span class="fl">0.119</span>, <span class="fl">0.078</span>, <span class="fl">1.624</span>, <span class="fl">0.553</span>, <span class="fl">0.523</span>,</span>
<span>       <span class="fl">0.644</span>, <span class="fl">0.284</span>, <span class="fl">1.744</span>, <span class="fl">1.468</span><span class="op">)</span></span></code></pre>
</div>
<p>If we add a <span class="math inline">\(\Gamma(2, 1)\)</span> prior,
the posterior distribution can be shown to be</p>
<p><span class="math display">\[p(\lambda | X) = \Gamma(2 + n, 1 +
\sum_{i}^{n}X_i),\]</span> where <span class="math inline">\(n\)</span>
is the number of observations.</p>
<p>Produce 1000 samples from the posterior and compute 1. posterior mean
and mode 2. 50%, 90% and 95% posterior intervals 3. the probabilities
that <span class="math inline">\(\lambda &gt; 1\)</span>, <span class="math inline">\(\lambda &lt; 1.5\)</span>, and <span class="math inline">\(1&lt;\lambda&lt;1.5\)</span></p>
</div>
<div class="section level3">
<h3 id="easy-marginal-posterior">(easy) Marginal posterior<a class="anchor" aria-label="anchor" href="#easy-marginal-posterior"></a>
</h3>
<p>Suppose the following piece of code produces samples from a
(bivariate) posterior for <span class="math inline">\(\theta =
(\theta_1, \theta_2).\)</span></p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">posterior_samples</span> <span class="op">&lt;-</span> <span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu">rmvnorm</span><span class="op">(</span><span class="fl">1000</span>,</span>
<span>                                      mean <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                                      sigma <span class="op">=</span> <span class="fu">matrix</span><span class="op">(</span><span class="fu">c</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.65</span>, <span class="fl">0.65</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make into a data frame</span></span>
<span><span class="va">posterior_samples</span> <span class="op">&lt;-</span> <span class="fu">data.frame</span><span class="op">(</span><span class="va">posterior_samples</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">set_colnames</span><span class="op">(</span><span class="fu">c</span><span class="op">(</span><span class="st">"theta1"</span>, <span class="st">"theta2"</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>Produce marginal posterior samples for <span class="math inline">\(\theta_1\)</span> and <span class="math inline">\(\theta_2\)</span>. Plot the full and marginal
posteriors. What information is lost if you only look at the marginal
posteriors?</p>
</div>
<div class="section level3">
<h3 id="medium-posterior-of-difference">(medium) Posterior of difference<a class="anchor" aria-label="anchor" href="#medium-posterior-of-difference"></a>
</h3>
<p>Consider the posterior distribution of the previous exercise. What is
the probability that <span class="math inline">\(\theta_1\)</span> is
larger than <span class="math inline">\(\theta_2\)</span>?</p>
</div>
<div class="section level3">
<h3 id="medium-sample-size-estimation">(medium) Sample size estimation<a class="anchor" aria-label="anchor" href="#medium-sample-size-estimation"></a>
</h3>
<p>Suppose we aim to estimate p, the proportion of left-handed people
very precisely (assume true p = 0.094). Specifically, we want the 99%
percentile interval of the posterior distribution of p to be only 0.05
wide. Approximately how large of a study sample do we need? Simulate, no
need to do analytical calculations. Use a prior of your liking.</p>
</div>
<div class="section level3">
<h3 id="medium-less-data-means-bigger-prior-effect">(medium) Less data means bigger prior effect<a class="anchor" aria-label="anchor" href="#medium-less-data-means-bigger-prior-effect"></a>
</h3>
<p>Explore the effec of sample size on the location and variance of the
posterior.</p>
<p>Instructions: - Set p ~ (0, 1) and generate data from the binomial
model. Simulate a sequence of 200 throws. - Draw samples form the the
analytical posterior using the first 5, 10, 15,â¦, 200 throws - Compute
the posterior mode and 90% CIs for each fit - Visualize the results by
generating a figure with: - the mode and CIs as the function of data
size - true parameter value - prior mode and CIs. - Check formulas
e.g.Â from Wikipedia - true analytical posterior mode and CIs using all
200 throws</p>
</div>
<div class="section level3">
<h3 id="hard-highest-posterior-density-set">(hard) Highest posterior density set<a class="anchor" aria-label="anchor" href="#hard-highest-posterior-density-set"></a>
</h3>
<p>Assume the following piece of code generates 5000 samples from a
posterior distribution.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">posterior_samples</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="fu">rnorm</span><span class="op">(</span><span class="fl">2500</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu">rnorm</span><span class="op">(</span><span class="fl">2500</span>, <span class="fl">1</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>Compute the 50% highest posterior density set (not necessarily an
interval!) of this distribution. Plot the set over a histogram of the
samples.</p>
<div class="section level4">
<h4 id="hint-1">Hint<a class="anchor" aria-label="anchor" href="#hint-1"></a>
</h4>
<ul>
<li>Generate the posterior density from the samples with the
<code>density</code> function.</li>
<li>Starting from the highest density, scan the density values in a
decreasing order. Determine the mass of the posterior corresponding to
the posterior above the particular density values. What does this set
represent?</li>
</ul>
</div>
</div>
</section><section id="stan"><h2 class="section-heading">Stan<a class="anchor" aria-label="anchor" href="#stan"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="easy-analyze-stan-programs">(easy) Analyze Stan programs<a class="anchor" aria-label="anchor" href="#easy-analyze-stan-programs"></a>
</h3>
<p>Write the statistical models implemented in the following Stan
programs and give some explanation on what they model.</p>
<ol style="list-style-type: decimal"><li>
</li></ol>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">STAN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode stan" tabindex="0"><code class="sourceCode stan"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span>{</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] X;</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> mu;</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; tau;</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  X ~ normal(mu, <span class="dv">1</span>/tau);</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  mu ~ normal(<span class="dv">0</span>, <span class="dv">10</span>);</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  tau ~ Gamma(<span class="dv">2</span>, <span class="dv">1</span>);</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
</div>
<ol start="2" style="list-style-type: decimal"><li>
</li></ol>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">STAN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode stan" tabindex="0"><code class="sourceCode stan"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span>{</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] X;</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[<span class="dv">3</span>] phi;</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">3</span>:N) {</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    X[i] ~ normal(phi[<span class="dv">1</span>] + phi[<span class="dv">2</span>]*X[i<span class="dv">-1</span>] + phi[<span class="dv">3</span>]*X[i<span class="dv">-2</span>], sigma);</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  phi ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
</div>
<ol start="3" style="list-style-type: decimal"><li>
</li></ol>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">STAN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode stan" tabindex="0"><code class="sourceCode stan"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span>{</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; n_groups;</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[n_groups] X;</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[n_groups] theta;</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(g <span class="cf">in</span> n_groups) {</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    X[g] ~ binomial(N, theta[g]);</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  theta ~ beta(alpha, beta);</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  alpha ~ gamma(<span class="dv">2</span>, <span class="fl">0.1</span>); </span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  beta ~ gamma(<span class="dv">2</span>, <span class="fl">0.1</span>);</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="easy-complete-stan-program">(easy) Complete Stan program<a class="anchor" aria-label="anchor" href="#easy-complete-stan-program"></a>
</h3>
<p>Fill the following Stan program for logistic regression</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">logistic_model</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">  data {</span></span>
<span><span class="st">    vector x;</span></span>
<span><span class="st">    int&lt;lower=0,upper=1&gt; y;</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  parameters {</span></span>
<span><span class="st">    alpha;</span></span>
<span><span class="st">    beta;</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  model {</span></span>
<span><span class="st">    y ~ bernoulli_logit(alpha + beta * x);</span></span>
<span><span class="st">    </span></span>
<span><span class="st">    alpha ~ ;</span></span>
<span><span class="st">    beta ~ ;</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">"</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="medium-estimate-dice-fairness">(medium) Estimate dice fairness<a class="anchor" aria-label="anchor" href="#medium-estimate-dice-fairness"></a>
</h3>
<p>Estimate the fairness of a 6 sided dice, that is, the probabilities
of getting each face on a random roll. The results from 99 rolls is
stored in the vector <code>rolls</code>.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rolls</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">6</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">4</span>,</span>
<span>           <span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">5</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">2</span>, <span class="fl">3</span>,</span>
<span>           <span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">6</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">5</span>,</span>
<span>           <span class="fl">5</span>, <span class="fl">2</span>, <span class="fl">6</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">1</span>, <span class="fl">6</span>, <span class="fl">4</span>,</span>
<span>           <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">2</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">5</span>, <span class="fl">2</span>, <span class="fl">6</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">4</span>,</span>
<span>           <span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">5</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">3</span>,</span>
<span>           <span class="fl">5</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">4</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">5</span>,</span>
<span>           <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre>
</div>
<p>Write a Stan program that implements the following statistical
model:</p>
<p><span class="math display">\[\begin{align}
y &amp; \sim categorial(\theta) \\
\theta &amp; \sim Dir(\textbf{1}),
\end{align}\]</span></p>
<p>Where <span class="math inline">\(Dir\)</span> is the Dirichlet
distribution with parameter <span class="math inline">\(\alpha = 1, 1,
\ldots, 1.\)</span> Plot the marginal posteriors for each <span class="math inline">\(\theta_i\)</span>. Is the dice fair? Quantify
this: give some probability for the hypothesis âthe dice is fairâ (for
example, compute the probability of for <span class="math inline">\(\theta_i &gt; \theta_j\)</span> for some <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>).</p>
</div>
<div class="section level3">
<h3 id="medium-basketbass-throws">(medium) Basketbass throws<a class="anchor" aria-label="anchor" href="#medium-basketbass-throws"></a>
</h3>
<p>Implement Beta regression in Stan that assumes data is generated from
a Beta(a, b) where a, b unknown parameters.</p>
<p>Use the program to analyze basketball free throw accuracy in the NBA
based on a sample of <span class="math inline">\(N=20\)</span> players.
Generate the posterior predictive distribution and compare to the full
data.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Data</span></span>
<span></span>
<span><span class="co"># Data from https://www.kaggle.com/datasets/nicklauskim/nba-per-game-stats-201920?resource=download&amp;select=nba_2020_advanced.csv</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"data/basketball.csv"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Rows: 651 Columns: 26
ââ Column specification ââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
Delimiter: ","
chr  (3): Player, Pos, Tm
dbl (23): Age, G, MP, PER, TS%, 3PAr, FTr, ORB%, DRB%, TRB%, AST%, STL%, BLK...

â¹ Use `spec()` to retrieve the full column specification for this data.
â¹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span></span>
<span><span class="co"># remove NAS and 0, 1</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="op">!</span><span class="fu">is.na</span><span class="op">(</span><span class="va">FTr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">FTr</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">FTr</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Choose random sample</span></span>
<span><span class="va">df_sample</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="fu">sample</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu">nrow</span><span class="op">(</span><span class="va">df</span><span class="op">)</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="op">]</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="medium-posteriorprior-predictive-check">(medium) Posterior/prior predictive check<a class="anchor" aria-label="anchor" href="#medium-posteriorprior-predictive-check"></a>
</h3>
<p>Consider linear regression with one dependent variable implemented in
the Stan program:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">STAN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode stan" tabindex="0"><code class="sourceCode stan"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N; <span class="co">// Sample size</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] x; <span class="co">// x-values</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] y; <span class="co">// y-values</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha; <span class="co">// intercept</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> beta;  <span class="co">// slope</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma; <span class="co">// noise</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Likelihood</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  y ~ normal(alpha + beta * x, sigma);</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  alpha ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  beta ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  sigma ~ gamma(<span class="dv">2</span>, <span class="dv">1</span>);</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
</div>
<p>and the following data:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="op">-</span><span class="fl">1.61</span>, <span class="fl">1.55</span>, <span class="op">-</span><span class="fl">0.14</span>, <span class="fl">0.27</span>, <span class="op">-</span><span class="fl">1.64</span>, <span class="fl">0.61</span>, <span class="op">-</span><span class="fl">0.17</span>, <span class="fl">1.56</span>, <span class="op">-</span><span class="fl">0.96</span>, <span class="fl">1.33</span>, <span class="fl">1.72</span>, <span class="fl">1.76</span>, <span class="fl">1.49</span>, <span class="op">-</span><span class="fl">1.55</span>, <span class="fl">0.69</span>, <span class="op">-</span><span class="fl">1.39</span>, <span class="fl">1.28</span>, <span class="fl">0.63</span>, <span class="op">-</span><span class="fl">0.96</span>, <span class="fl">0.13</span>, <span class="op">-</span><span class="fl">1.33</span>, <span class="fl">1.07</span>, <span class="fl">1.01</span>, <span class="op">-</span><span class="fl">1.94</span>, <span class="fl">1.2</span>, <span class="fl">0.36</span>, <span class="fl">1.38</span>, <span class="fl">0.08</span>, <span class="fl">1.47</span>, <span class="fl">0.32</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="op">-</span><span class="fl">1.84</span>, <span class="fl">2.06</span>, <span class="fl">0.41</span>, <span class="fl">1.09</span>, <span class="op">-</span><span class="fl">2.3</span>, <span class="fl">1.22</span>, <span class="fl">2.02</span>, <span class="fl">4.03</span>, <span class="fl">0.52</span>, <span class="fl">2.76</span>, <span class="fl">3.66</span>, <span class="fl">0.43</span>, <span class="fl">4.62</span>, <span class="op">-</span><span class="fl">0.03</span>, <span class="fl">0.16</span>, <span class="op">-</span><span class="fl">0.1</span>, <span class="fl">2.82</span>, <span class="fl">1.63</span>, <span class="op">-</span><span class="fl">0.35</span>, <span class="fl">0.89</span>, <span class="fl">0.29</span>, <span class="fl">0.78</span>, <span class="fl">1.9</span>, <span class="fl">0.26</span>, <span class="fl">0.84</span>, <span class="fl">1.06</span>, <span class="fl">2.93</span>, <span class="fl">3.38</span>, <span class="fl">2.44</span>, <span class="fl">2.48</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fl">0.75</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></code></pre>
</div>
<p>Use Stan to do the following:</p>
<ol style="list-style-type: decimal">
<li>Posterior predictive check (for same data):</li>
</ol>
<ol style="list-style-type: lower-alpha">
<li>Simulate output data (response variable y) from the posterior for
the same input data (predictor variable x).</li>
<li>Compare the simulated and original responses that were used for
model inference. There are many possible ways to compare original and
simulated y, propose your own solution.</li>
</ol>
<p>Tip: Stan manual page on posterior predictive distribution: <a href="https://mc-stan.org/docs/stan-users-guide/simulating-from-the-posterior-predictive-distribution.html" class="external-link uri">https://mc-stan.org/docs/stan-users-guide/simulating-from-the-posterior-predictive-distribution.html</a></p>
<ol start="2" style="list-style-type: decimal">
<li>Posterior predictions (for new data):</li>
</ol>
<ol style="list-style-type: lower-alpha">
<li>Simulate data from the posterior of the linear model for new
(different) input data (x_new).</li>
<li>Compare the simulated and original responses that were used for
model inference. There are many possible ways to compare original and
simulated y, propose your own solution.</li>
</ol>
<ol start="3" style="list-style-type: decimal">
<li>Prior predictive checks:</li>
</ol>
<ol style="list-style-type: lower-alpha">
<li>Generate samples (for y) from the prior predictive
distribution.</li>
<li>Compare prior and posterior simulations for y; try both informative
and uninformative priors; is there any difference?</li>
</ol>
<p>Tip: note that this can be implented in Stan but you do not
necessarily need Stan to draw samples from the prior distribution.</p>
</div>
<div class="section level3">
<h3 id="hard-write-stan-program-oup">(hard) Write Stan program: OUP<a class="anchor" aria-label="anchor" href="#hard-write-stan-program-oup"></a>
</h3>
<p>The Ornstein-Uhlenbeck process (OUP) can be used (among other things)
as a part in algorithmic trading strategies. The model is a stochastic
differential equation defined as</p>
<p><span class="math display">\[dX_t = \phi(\mu - X_t) + \sigma
dW,\]</span> where <span class="math inline">\(X_t\)</span> is the state
variable at time <span class="math inline">\(t\)</span>, <span class="math inline">\(\mu\)</span> is the mean level, <span class="math inline">\(\phi\)</span> the mean-reversion rate, and <span class="math inline">\(\sigma\)</span> determines the level of stochastic
variations of the process. <span class="math inline">\(dW\)</span> is a
so-called Wiener process, of which you can read more about elsewhere.
The parameter <span class="math inline">\(\phi\)</span> determines how
quickly the process returns towards <span class="math inline">\(\mu\)</span> if the system is driven away from
<span class="math inline">\(\mu.\)</span></p>
<p>The nice thing about the OUP is that it is analytically tractable,
meaning that the transition density between different time points is
known. In other words, <span class="math inline">\(p(X_{t + dt} | X_t) =
N(\mu - (\mu - X_t)e^{-\lambda t}, \frac{\sigma^2}{2\phi}(1-e^{-2\phi
t})).\)</span> This allows writing the likelihood for the data!</p>
<p>Implement the OUP in Stan and fit it on the data provided below. The
data is the daily stock price of Exxon Mobil over the past 2 years
(minus the 20 day exponential moving average, provided by Yahoo). Plot
the posteriors of the model parameters. How could you use the analysis
to make trading decisions (this is not an investment
recommendation)?</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exxon</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="op">-</span><span class="fl">6.71</span>, <span class="op">-</span><span class="fl">8.31</span>, <span class="op">-</span><span class="fl">5.79</span>, <span class="op">-</span><span class="fl">7.72</span>, <span class="op">-</span><span class="fl">8.37</span>, <span class="op">-</span><span class="fl">5.16</span>, <span class="op">-</span><span class="fl">4.55</span>, <span class="op">-</span><span class="fl">4.51</span>, <span class="op">-</span><span class="fl">5.11</span>, <span class="op">-</span><span class="fl">4.32</span>, <span class="op">-</span><span class="fl">5.45</span>, <span class="op">-</span><span class="fl">3.66</span>, <span class="op">-</span><span class="fl">1.9</span>, <span class="fl">0.24</span>, <span class="fl">1.1</span>, <span class="op">-</span><span class="fl">0.35</span>, <span class="op">-</span><span class="fl">0.93</span>, <span class="fl">1.79</span>, <span class="fl">1.3</span>, <span class="fl">2.93</span>, <span class="fl">3.62</span>, <span class="fl">7.16</span>, <span class="fl">4.26</span>, <span class="fl">3.48</span>, <span class="fl">0.39</span>, <span class="op">-</span><span class="fl">3.11</span>, <span class="op">-</span><span class="fl">1.68</span>, <span class="op">-</span><span class="fl">1.06</span>, <span class="fl">0.52</span>, <span class="fl">1.25</span>, <span class="fl">2.71</span>, <span class="fl">3.18</span>, <span class="fl">1.36</span>, <span class="fl">0.45</span>, <span class="fl">1.08</span>, <span class="fl">2.95</span>, <span class="fl">2.39</span>, <span class="fl">2.1</span>, <span class="fl">5.51</span>, <span class="fl">5.51</span>, <span class="fl">5.45</span>, <span class="fl">3.83</span>, <span class="fl">5.5</span>, <span class="fl">1.53</span>, <span class="fl">0.73</span>, <span class="op">-</span><span class="fl">0.9</span>, <span class="fl">0.75</span>, <span class="fl">0.1</span>, <span class="op">-</span><span class="fl">0.65</span>, <span class="fl">0.11</span>, <span class="fl">1.54</span>, <span class="fl">2.4</span>, <span class="fl">0.11</span>, <span class="fl">2.21</span>, <span class="op">-</span><span class="fl">0.57</span>, <span class="op">-</span><span class="fl">1.98</span>, <span class="op">-</span><span class="fl">1.8</span>, <span class="op">-</span><span class="fl">2.32</span>, <span class="op">-</span><span class="fl">3.44</span>, <span class="op">-</span><span class="fl">3.46</span>, <span class="op">-</span><span class="fl">7.49</span>, <span class="op">-</span><span class="fl">8.38</span>, <span class="op">-</span><span class="fl">5.99</span>, <span class="op">-</span><span class="fl">2.6</span>, <span class="op">-</span><span class="fl">2.51</span>, <span class="op">-</span><span class="fl">3.51</span>, <span class="fl">0.99</span>, <span class="fl">3.93</span>, <span class="fl">7.04</span>, <span class="fl">9.03</span>, <span class="fl">7.24</span>, <span class="fl">4.57</span>, <span class="fl">3.37</span>, <span class="fl">3.44</span>, <span class="fl">6.22</span>, <span class="fl">3.21</span>, <span class="fl">4.2</span>, <span class="fl">3.96</span>, <span class="fl">6.29</span>, <span class="fl">5.81</span>, <span class="fl">7.01</span>, <span class="fl">7.01</span>, <span class="fl">5.69</span>, <span class="fl">6.29</span>, <span class="fl">6.06</span>, <span class="fl">8.33</span>, <span class="fl">7.64</span>, <span class="fl">7.91</span>, <span class="fl">5.07</span>, <span class="fl">5.94</span>, <span class="fl">6.47</span>, <span class="fl">7.05</span>, <span class="fl">6.71</span>, <span class="fl">1.46</span>, <span class="fl">2.76</span>, <span class="fl">5.62</span>, <span class="fl">4.56</span>, <span class="fl">4.82</span>, <span class="fl">3.25</span>, <span class="fl">3.08</span>, <span class="fl">1.9</span>, <span class="fl">0.71</span>, <span class="fl">3.55</span>, <span class="fl">2.7</span>, <span class="fl">2.08</span>, <span class="op">-</span><span class="fl">1.2</span>, <span class="op">-</span><span class="fl">0.42</span>, <span class="fl">0.34</span>, <span class="op">-</span><span class="fl">0.18</span>, <span class="op">-</span><span class="fl">1.01</span>, <span class="op">-</span><span class="fl">3.64</span>, <span class="op">-</span><span class="fl">5.98</span>, <span class="op">-</span><span class="fl">5.62</span>, <span class="op">-</span><span class="fl">4.39</span>, <span class="op">-</span><span class="fl">4.77</span>, <span class="op">-</span><span class="fl">2</span>, <span class="op">-</span><span class="fl">0.76</span>, <span class="op">-</span><span class="fl">1.41</span>, <span class="op">-</span><span class="fl">2.19</span>, <span class="op">-</span><span class="fl">2.66</span>, <span class="op">-</span><span class="fl">1.98</span>, <span class="op">-</span><span class="fl">0.41</span>, <span class="fl">0.87</span>, <span class="op">-</span><span class="fl">1.19</span>, <span class="fl">1.46</span>, <span class="fl">2.68</span>, <span class="fl">0.79</span>, <span class="fl">1.46</span>, <span class="fl">2.31</span>, <span class="op">-</span><span class="fl">1.34</span>, <span class="op">-</span><span class="fl">0.93</span>, <span class="fl">1.32</span>, <span class="fl">2.39</span>, <span class="fl">0.3</span>, <span class="fl">1.74</span>, <span class="fl">2.73</span>, <span class="fl">4.14</span>, <span class="fl">3.69</span>, <span class="fl">3.14</span>, <span class="fl">0.74</span>, <span class="fl">1.31</span>, <span class="fl">3.02</span>, <span class="fl">2.2</span>, <span class="fl">2.94</span>, <span class="fl">2.12</span>, <span class="fl">6.03</span>, <span class="fl">3.51</span>, <span class="fl">1.32</span>, <span class="fl">3.41</span>, <span class="fl">1.94</span>, <span class="op">-</span><span class="fl">1.49</span>, <span class="op">-</span><span class="fl">0.65</span>, <span class="op">-</span><span class="fl">0.76</span>, <span class="fl">2.2</span>, <span class="fl">1.08</span>, <span class="fl">1.37</span>, <span class="fl">5.6</span>, <span class="fl">3.83</span>, <span class="fl">2.21</span>, <span class="fl">1.69</span>, <span class="fl">1.22</span>, <span class="op">-</span><span class="fl">2.92</span>, <span class="op">-</span><span class="fl">2.75</span>, <span class="op">-</span><span class="fl">3.79</span>, <span class="op">-</span><span class="fl">2.51</span>, <span class="op">-</span><span class="fl">2.26</span>, <span class="op">-</span><span class="fl">2.23</span>, <span class="op">-</span><span class="fl">2.6</span>, <span class="op">-</span><span class="fl">1.46</span>, <span class="op">-</span><span class="fl">0.86</span>, <span class="fl">0.5</span>, <span class="fl">1.35</span>, <span class="op">-</span><span class="fl">0.77</span>, <span class="op">-</span><span class="fl">2.17</span>, <span class="op">-</span><span class="fl">2.73</span>, <span class="op">-</span><span class="fl">3.69</span>, <span class="op">-</span><span class="fl">4.46</span>, <span class="op">-</span><span class="fl">3.68</span>, <span class="op">-</span><span class="fl">8.14</span>, <span class="op">-</span><span class="fl">7.9</span>, <span class="op">-</span><span class="fl">8.22</span>, <span class="op">-</span><span class="fl">5.08</span>, <span class="op">-</span><span class="fl">0.44</span>, <span class="op">-</span><span class="fl">2.62</span>, <span class="op">-</span><span class="fl">3.43</span>, <span class="op">-</span><span class="fl">3</span>, <span class="op">-</span><span class="fl">0.66</span>, <span class="fl">0.6</span>, <span class="fl">2.21</span>, <span class="fl">2.48</span>, <span class="fl">2.39</span>, <span class="fl">8.02</span>, <span class="fl">6.25</span>, <span class="fl">7.44</span>, <span class="fl">4.97</span>, <span class="fl">4.04</span>, <span class="fl">4.39</span>, <span class="fl">3.86</span>, <span class="fl">3.98</span>, <span class="fl">3.86</span>, <span class="fl">2.27</span>, <span class="fl">4.08</span>, <span class="fl">3.35</span>, <span class="fl">2.19</span>, <span class="fl">2.32</span>, <span class="fl">4.08</span>, <span class="fl">2.17</span>, <span class="fl">1</span>, <span class="fl">2.15</span>, <span class="fl">3.31</span>, <span class="op">-</span><span class="fl">0.32</span>, <span class="op">-</span><span class="fl">4.43</span>, <span class="op">-</span><span class="fl">5.97</span>, <span class="op">-</span><span class="fl">7.11</span>, <span class="op">-</span><span class="fl">4.05</span>, <span class="op">-</span><span class="fl">3.27</span>, <span class="op">-</span><span class="fl">2.93</span>, <span class="op">-</span><span class="fl">3.92</span>, <span class="op">-</span><span class="fl">5.31</span>, <span class="op">-</span><span class="fl">4.81</span>, <span class="op">-</span><span class="fl">5</span>, <span class="op">-</span><span class="fl">6.83</span>, <span class="op">-</span><span class="fl">4.1</span>, <span class="op">-</span><span class="fl">2.85</span>, <span class="op">-</span><span class="fl">2.13</span>, <span class="op">-</span><span class="fl">3.1</span>, <span class="op">-</span><span class="fl">1.51</span>, <span class="op">-</span><span class="fl">0.29</span>, <span class="op">-</span><span class="fl">2.01</span>, <span class="op">-</span><span class="fl">2.44</span>, <span class="op">-</span><span class="fl">3.05</span><span class="op">)</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="hard-implement-logistic-growth">(hard) Implement logistic growth<a class="anchor" aria-label="anchor" href="#hard-implement-logistic-growth"></a>
</h3>
<p>In ecology, evolution of population size is often modeled using
logistic growth which is defined by the differential equation</p>
<p><span class="math display">\[\frac{dP}{dt} =
rP(1-\frac{P}{K}),\]</span> where <span class="math inline">\(P\)</span>
is the population size, <span class="math inline">\(t\)</span> time,
<span class="math inline">\(r\)</span> the growth rate. The carrying
capacity <span class="math inline">\(K\)</span> determines the maximum
size of the population, and without it the population would grow
exponentially. The solution to this differential equation is</p>
<p><span class="math display">\[P(t) = \frac{K}{1 + (\frac{K}{P_0} -
1)e^{-rt}}.\]</span> In other words, the solution gives the population
size at time <span class="math inline">\(t\)</span>, given the initial
size <span class="math inline">\(P_0\)</span> and the model
parameters.</p>
<p>The following data contains (noisy and scaled) measurements of an
<strong>E. coli</strong> bacteria culture measured for 1 day
(Sprouffske, Wagner, Growthcurver (2016): an R package for obtaining
interpretable metrics from microbial growth curves (2016)).</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">E.coli</span> <span class="op">&lt;-</span> <span class="fu">data.frame</span><span class="op">(</span></span>
<span>  time <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.167</span>, <span class="fl">0.333</span>, <span class="fl">0.5</span>, <span class="fl">0.667</span>, <span class="fl">0.833</span>, <span class="fl">1</span>, <span class="fl">1.167</span>, <span class="fl">1.333</span>, <span class="fl">1.5</span>, <span class="fl">1.667</span>, <span class="fl">1.833</span>, <span class="fl">2</span>, <span class="fl">2.167</span>, <span class="fl">2.333</span>, <span class="fl">2.5</span>, <span class="fl">2.667</span>, <span class="fl">2.833</span>, <span class="fl">3</span>, <span class="fl">3.167</span>, <span class="fl">3.333</span>, <span class="fl">3.5</span>, <span class="fl">3.667</span>, <span class="fl">3.833</span>, <span class="fl">4</span>, <span class="fl">4.167</span>, <span class="fl">4.333</span>, <span class="fl">4.5</span>, <span class="fl">4.667</span>, <span class="fl">4.833</span>, <span class="fl">5</span>, <span class="fl">5.167</span>, <span class="fl">5.333</span>, <span class="fl">5.5</span>, <span class="fl">5.667</span>, <span class="fl">5.833</span>, <span class="fl">6</span>, <span class="fl">6.167</span>, <span class="fl">6.333</span>, <span class="fl">6.5</span>, <span class="fl">6.667</span>, <span class="fl">6.833</span>, <span class="fl">7</span>, <span class="fl">7.167</span>, <span class="fl">7.333</span>, <span class="fl">7.5</span>, <span class="fl">7.667</span>, <span class="fl">7.833</span>, <span class="fl">8</span>, <span class="fl">8.167</span>, <span class="fl">8.333</span>, <span class="fl">8.5</span>, <span class="fl">8.667</span>, <span class="fl">8.833</span>, <span class="fl">9</span>, <span class="fl">9.167</span>, <span class="fl">9.333</span>, <span class="fl">9.5</span>, <span class="fl">9.667</span>, <span class="fl">9.833</span>, <span class="fl">10</span>, <span class="fl">10.167</span>, <span class="fl">10.333</span>, <span class="fl">10.5</span>, <span class="fl">10.667</span>, <span class="fl">10.833</span>, <span class="fl">11</span>, <span class="fl">11.167</span>, <span class="fl">11.333</span>, <span class="fl">11.5</span>, <span class="fl">11.667</span>, <span class="fl">11.833</span>, <span class="fl">12</span>, <span class="fl">12.167</span>, <span class="fl">12.333</span>, <span class="fl">12.5</span>, <span class="fl">12.667</span>, <span class="fl">12.833</span>, <span class="fl">13</span>, <span class="fl">13.167</span>, <span class="fl">13.333</span>, <span class="fl">13.5</span>, <span class="fl">13.667</span>, <span class="fl">13.833</span>, <span class="fl">14</span>, <span class="fl">14.167</span>, <span class="fl">14.333</span>, <span class="fl">14.5</span>, <span class="fl">14.667</span>, <span class="fl">14.833</span>, <span class="fl">15</span>, <span class="fl">15.167</span>, <span class="fl">15.333</span>, <span class="fl">15.5</span>, <span class="fl">15.667</span>, <span class="fl">15.833</span>, <span class="fl">16</span>, <span class="fl">16.167</span>, <span class="fl">16.333</span>, <span class="fl">16.5</span>, <span class="fl">16.667</span>, <span class="fl">16.833</span>, <span class="fl">17</span>, <span class="fl">17.167</span>, <span class="fl">17.333</span>, <span class="fl">17.5</span>, <span class="fl">17.667</span>, <span class="fl">17.833</span>, <span class="fl">18</span>, <span class="fl">18.167</span>, <span class="fl">18.333</span>, <span class="fl">18.5</span>, <span class="fl">18.667</span>, <span class="fl">18.833</span>, <span class="fl">19</span>, <span class="fl">19.167</span>, <span class="fl">19.333</span>, <span class="fl">19.5</span>, <span class="fl">19.667</span>, <span class="fl">19.833</span>, <span class="fl">20</span>, <span class="fl">20.167</span>, <span class="fl">20.333</span>, <span class="fl">20.5</span>, <span class="fl">20.667</span>, <span class="fl">20.833</span>, <span class="fl">21</span>, <span class="fl">21.167</span>, <span class="fl">21.333</span>, <span class="fl">21.5</span>, <span class="fl">21.667</span>, <span class="fl">21.833</span>, <span class="fl">22</span>, <span class="fl">22.167</span>, <span class="fl">22.333</span>, <span class="fl">22.5</span>, <span class="fl">22.667</span>, <span class="fl">22.833</span>, <span class="fl">23</span>, <span class="fl">23.167</span>, <span class="fl">23.333</span>, <span class="fl">23.5</span>, <span class="fl">23.667</span>, <span class="fl">23.833</span>, <span class="fl">24</span><span class="op">)</span>, </span>
<span>  abundance <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.005</span>, <span class="fl">0.013</span>, <span class="fl">0.008</span>, <span class="fl">0.002</span>, <span class="fl">0.01</span>, <span class="fl">0.006</span>, <span class="fl">0.006</span>, <span class="fl">0.003</span>, <span class="fl">0.009</span>, <span class="fl">0.01</span>, <span class="fl">0.006</span>, <span class="fl">0.011</span>, <span class="fl">0</span>, <span class="fl">0.001</span>, <span class="fl">0.006</span>, <span class="fl">0.007</span>, <span class="fl">0.004</span>, <span class="fl">0.006</span>, <span class="fl">0.005</span>, <span class="fl">0.003</span>, <span class="fl">0.008</span>, <span class="fl">0.006</span>, <span class="fl">0.011</span>, <span class="fl">0.008</span>, <span class="fl">0.015</span>, <span class="fl">0.008</span>, <span class="fl">0.006</span>, <span class="fl">0.013</span>, <span class="fl">0.01</span>, <span class="fl">0.013</span>, <span class="fl">0.016</span>, <span class="fl">0.018</span>, <span class="fl">0.013</span>, <span class="fl">0.015</span>, <span class="fl">0.013</span>, <span class="fl">0.019</span>, <span class="fl">0.021</span>, <span class="fl">0.024</span>, <span class="fl">0.03</span>, <span class="fl">0.03</span>, <span class="fl">0.036</span>, <span class="fl">0.04</span>, <span class="fl">0.045</span>, <span class="fl">0.059</span>, <span class="fl">0.064</span>, <span class="fl">0.072</span>, <span class="fl">0.083</span>, <span class="fl">0.093</span>, <span class="fl">0.111</span>, <span class="fl">0.123</span>, <span class="fl">0.137</span>, <span class="fl">0.154</span>, <span class="fl">0.176</span>, <span class="fl">0.183</span>, <span class="fl">0.201</span>, <span class="fl">0.218</span>, <span class="fl">0.231</span>, <span class="fl">0.248</span>, <span class="fl">0.261</span>, <span class="fl">0.267</span>, <span class="fl">0.287</span>, <span class="fl">0.288</span>, <span class="fl">0.293</span>, <span class="fl">0.299</span>, <span class="fl">0.306</span>, <span class="fl">0.309</span>, <span class="fl">0.314</span>, <span class="fl">0.321</span>, <span class="fl">0.324</span>, <span class="fl">0.326</span>, <span class="fl">0.331</span>, <span class="fl">0.328</span>, <span class="fl">0.33</span>, <span class="fl">0.325</span>, <span class="fl">0.337</span>, <span class="fl">0.331</span>, <span class="fl">0.337</span>, <span class="fl">0.333</span>, <span class="fl">0.335</span>, <span class="fl">0.338</span>, <span class="fl">0.335</span>, <span class="fl">0.332</span>, <span class="fl">0.332</span>, <span class="fl">0.333</span>, <span class="fl">0.332</span>, <span class="fl">0.332</span>, <span class="fl">0.337</span>, <span class="fl">0.336</span>, <span class="fl">0.335</span>, <span class="fl">0.33</span>, <span class="fl">0.34</span>, <span class="fl">0.333</span>, <span class="fl">0.332</span>, <span class="fl">0.337</span>, <span class="fl">0.337</span>, <span class="fl">0.336</span>, <span class="fl">0.336</span>, <span class="fl">0.336</span>, <span class="fl">0.335</span>, <span class="fl">0.334</span>, <span class="fl">0.339</span>, <span class="fl">0.335</span>, <span class="fl">0.336</span>, <span class="fl">0.337</span>, <span class="fl">0.335</span>, <span class="fl">0.332</span>, <span class="fl">0.333</span>, <span class="fl">0.334</span>, <span class="fl">0.337</span>, <span class="fl">0.334</span>, <span class="fl">0.33</span>, <span class="fl">0.337</span>, <span class="fl">0.333</span>, <span class="fl">0.339</span>, <span class="fl">0.335</span>, <span class="fl">0.329</span>, <span class="fl">0.332</span>, <span class="fl">0.338</span>, <span class="fl">0.333</span>, <span class="fl">0.329</span>, <span class="fl">0.334</span>, <span class="fl">0.338</span>, <span class="fl">0.344</span>, <span class="fl">0.335</span>, <span class="fl">0.334</span>, <span class="fl">0.337</span>, <span class="fl">0.337</span>, <span class="fl">0.334</span>, <span class="fl">0.334</span>, <span class="fl">0.331</span>, <span class="fl">0.34</span>, <span class="fl">0.336</span>, <span class="fl">0.34</span>, <span class="fl">0.34</span>, <span class="fl">0.336</span>, <span class="fl">0.337</span>, <span class="fl">0.34</span>, <span class="fl">0.337</span>, <span class="fl">0.333</span>, <span class="fl">0.328</span>, <span class="fl">0.339</span>, <span class="fl">0.334</span>, <span class="fl">0.332</span>, <span class="fl">0.336</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>Write a Stan program for the logistic growth model and estimate the
growth rate and carrying capacity for this <strong>E. coli</strong>
strain. Plot the marginal posteriors for <span class="math inline">\(P_0\)</span>, <span class="math inline">\(r\)</span> and <span class="math inline">\(K.\)</span> Generate a posterior of growth
trajectories and plot it against the data.</p>
</div>
</section><section id="mcmc"><h2 class="section-heading">MCMC<a class="anchor" aria-label="anchor" href="#mcmc"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="medium-gibbs-sampler">(medium) Gibbs sampler<a class="anchor" aria-label="anchor" href="#medium-gibbs-sampler"></a>
</h3>
<p>Consider the distribution p(x, y) = exp{-(x<sup>2y</sup>2 + x^2 + y^2
-8x -8y)/2}/C, where C is a normalizing constant. It is known that the
conditional distribution of x given y is the normal distribution p(x|y)
= N(mu, sigma), where the mean mu = 4/(1 + y^2) and the standard
deviation sigma = sqrt(1/(1 + y^2)). Due to symmetry, p(y|x) can be
recovered simply by changing yâs to xâs in p(x|y).</p>
<p>The Gibbs sampler is a special case of the Metropolis-Hastings
algorithm. It can be stated as follows: 1) Choose some initial values
for the parameters. Letâs call them x_0 and y_0 in our case. 2) The
following samples are generated as follows: For i = 1, â¦, N: a) Draw x_i
from p(x|y_{i-1}) b) Draw y_i from p(y|x_i)</p>
<p>(In this notation x_i refers to the x sample at step i, y_{i-1} to
the y sample at step i-1 and so on)</p>
<p>Build a Gibbs sampler that draws samples from p(x, y). Visualize the
resulting distribution.</p>
</div>
<div class="section level3">
<h3 id="hard-metropolis-hastings-normal">(hard) Metropolis-Hastings: Normal<a class="anchor" aria-label="anchor" href="#hard-metropolis-hastings-normal"></a>
</h3>
<ol style="list-style-type: lower-alpha">
<li><p>Generate data from the normal distribution. Implement a
Metropolis sampler for the normal model that estimates the mean and
variance. Use a normal distribution to generate the proposals.</p></li>
<li><p>Run 4 chains with distinct (e.g.Â random) initial values and plot
the chainâs trajectories in parameter space along with trace plots. How
does the proposal distributionâs variance affect the chains and the
resulting posterior samples?</p></li>
</ol>
<div class="section level4">
<h4 id="hint-2">Hint<a class="anchor" aria-label="anchor" href="#hint-2"></a>
</h4>
<p>See <a href="https://www.statisticshowto.com/metropolis-hastings-algorithm/" class="external-link uri">https://www.statisticshowto.com/metropolis-hastings-algorithm/</a>
for a description of Metropolis See Statistical Rethinking: Overthinking
box p.45 for a binomial example. Work with logarithms to avoid underflow
Think of what do to with negative proposals for the variance
parameter</p>
</div>
</div>
<div class="section level3">
<h3 id="hard-rhat">(hard) Rhat<a class="anchor" aria-label="anchor" href="#hard-rhat"></a>
</h3>
<p>Implement the <span class="math inline">\(\hat{R}\)</span> diagnostic
and compute it for posterior samples generated from some model (e.g.Â the
normal model of the previous exercise). Definition of the diagnostic can
be found in BDA3 p.Â 285.</p>
</div>
</section><section id="hierarchical-models"><h2 class="section-heading">Hierarchical models<a class="anchor" aria-label="anchor" href="#hierarchical-models"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="easy-analyze-models">(easy) Analyze models<a class="anchor" aria-label="anchor" href="#easy-analyze-models"></a>
</h3>
<p>Are the following statistical models hierarchical? If not, make
modifications that turn them into hierarchical.</p>
<ol style="list-style-type: decimal"><li>
</li></ol>
<p><span class="math display">\[\begin{align}
  y_{group, i} &amp; \sim Normal(a_{group} + b x_{group, i}, \sigma) \\
  a_{group} &amp; \sim Normal(0, 1) \\
  b &amp; \sim Normal(0, 1) \\
  \sigma &amp; \sim Exponential(1)
\end{align}\]</span></p>
<ol start="2" style="list-style-type: decimal"><li>
</li></ol>
<p><span class="math display">\[\begin{align}
  y_i &amp;\sim Binomial(1, p_i) \\
  logit(p_i) &amp;= a_{group, i} + b x_i \\
  a_{group} &amp;\sim N(\alpha, 1) \\
  \alpha &amp;\sim N(0, 100) \\
  b &amp; \sim Normal(0, 1)
\end{align}\]</span></p>
<ol start="3" style="list-style-type: decimal"><li>
</li></ol>
<p><span class="math display">\[\begin{align}
  X_i &amp; \sim \Gamma(\alpha, \beta) \\
  \alpha &amp;\sim \Gamma(1, 1) \\
  \beta &amp;\sim \Gamma(1, 1) \\
\end{align}\]</span></p>
</div>
<div class="section level3">
<h3 id="medium-laborous-hierarchical-coin-analysis">(medium, laborous) Hierarchical coin analysis<a class="anchor" aria-label="anchor" href="#medium-laborous-hierarchical-coin-analysis"></a>
</h3>
<p>Estimate the fairness of a collection of coins. Fit pooled, unpooled
and partially pooled binomial models to the provided data. Generate a
figure that compares the posteriors. Plot also the population
distribution. What information does the population distribution
give?</p>
<p>Generate data</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Data</span></span>
<span><span class="va">G</span> <span class="op">&lt;-</span> <span class="fl">15</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu">rep</span><span class="op">(</span><span class="fl">25</span>, <span class="va">G</span><span class="op">)</span></span>
<span><span class="va">p_true</span> <span class="op">&lt;-</span> <span class="fu">rbeta</span><span class="op">(</span><span class="va">G</span>, <span class="fl">50</span>, <span class="fl">55</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">sort</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">rbinom</span><span class="op">(</span>n <span class="op">=</span> <span class="va">G</span>, size <span class="op">=</span> <span class="va">N</span>, prob <span class="op">=</span> <span class="va">p_true</span><span class="op">)</span></span></code></pre>
</div>
</div>
</section><section id="model-critisism"><h2 class="section-heading">Model critisism<a class="anchor" aria-label="anchor" href="#model-critisism"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="easy-explanation-1">(easy) Explanation<a class="anchor" aria-label="anchor" href="#easy-explanation-1"></a>
</h3>
<p>Explain in your own words: a) the purpose of information criteria b)
log pointwise predictive distribution (lppd) c) what is the fundamental
difference between DIC/AIC and WAIC?</p>
</div>
<div class="section level3">
<h3 id="medium-posterior-predictive-check">(medium) Posterior predictive check<a class="anchor" aria-label="anchor" href="#medium-posterior-predictive-check"></a>
</h3>
<p>Build a Stan model that estimates the mean and standard deviation of
a normal distribution. Fit the model to the data in data1.txt and do a
posterior predictive check (for example a visual one). What are your
conclusions about the modelâs suitability on this data based on the PPD?
What steps would you take next?</p>
<p>Hint: you can generate the PPD in R/Python or in the generated
quantities block in Stan</p>
</div>
<div class="section level3">
<h3 id="hard-waic-based-model-selection">(hard) WAIC-based model selection<a class="anchor" aria-label="anchor" href="#hard-waic-based-model-selection"></a>
</h3>
<p>Let us consider the polynomial regression models with 0 (intercept
only), 1 (linear regression), 2 (quadratic), 3 (cubic) degrees. Which of
these four models best describes the provided data in terms of the
WAIC?</p>
<p>Use the provided Stan models and implement the WAIC in R/Python.</p>
<p>Hint: See Statistical Rethinking p.220 for definition of WAIC and
Overthinking box on p.210. Can also be found in p.Â 173 in BDA3.</p>
<p>Data:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="op">-</span><span class="fl">0.54</span>, <span class="fl">0.72</span>, <span class="fl">1.12</span>, <span class="fl">0.57</span>, <span class="fl">0.61</span>, <span class="fl">0.89</span>, <span class="op">-</span><span class="fl">0.45</span>, <span class="fl">0.66</span>, <span class="fl">1.19</span>, <span class="op">-</span><span class="fl">1.26</span>, <span class="op">-</span><span class="fl">1.4</span>, <span class="fl">0.28</span>, <span class="op">-</span><span class="fl">0.42</span>, <span class="op">-</span><span class="fl">1.24</span>, <span class="fl">0.45</span>, <span class="fl">0.6</span>, <span class="op">-</span><span class="fl">0.92</span>, <span class="op">-</span><span class="fl">1.42</span>, <span class="fl">0.81</span>, <span class="op">-</span><span class="fl">0.41</span>, <span class="op">-</span><span class="fl">1.22</span>, <span class="fl">1.31</span>, <span class="op">-</span><span class="fl">0.38</span>, <span class="op">-</span><span class="fl">1.22</span>, <span class="op">-</span><span class="fl">1.02</span><span class="op">)</span></span>
<span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0.53</span>, <span class="fl">2.15</span>, <span class="fl">3.23</span>, <span class="fl">3.48</span>, <span class="fl">5.08</span>, <span class="fl">4.07</span>, <span class="fl">2.23</span>, <span class="fl">3.06</span>, <span class="fl">4.78</span>, <span class="fl">1.35</span>, <span class="fl">1.24</span>, <span class="fl">2.87</span>, <span class="fl">1.22</span>, <span class="op">-</span><span class="fl">0.48</span>, <span class="fl">3.48</span>, <span class="fl">4.03</span>, <span class="op">-</span><span class="fl">0.05</span>, <span class="op">-</span><span class="fl">0.19</span>, <span class="fl">2.31</span>, <span class="fl">0.96</span>, <span class="fl">1.14</span>, <span class="fl">6.85</span>, <span class="op">-</span><span class="fl">1.1</span>, <span class="op">-</span><span class="fl">1.32</span>, <span class="op">-</span><span class="fl">0.83</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">data.frame</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span></code></pre>
</div>
<p>Stan programs:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">STAN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode stan" tabindex="0"><code class="sourceCode stan"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// intercept only</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span>{</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N;</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] x;</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] y;</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span>{</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> a;</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span>{</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Likelihood</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  y ~ normal(a, sigma);</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  a ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  sigma ~ gamma(<span class="dv">2</span>, <span class="dv">1</span>);</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">STAN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode stan" tabindex="0"><code class="sourceCode stan"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">// linear</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span>{</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N;</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] x;</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] y;</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span>{</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> a;</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> b;</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span>{</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Likelihood</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  y ~ normal(a + b*x, sigma);</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  a ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  b ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  sigma ~ gamma(<span class="dv">2</span>, <span class="dv">1</span>);</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">STAN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode stan" tabindex="0"><code class="sourceCode stan"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// quadratic</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span>{</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N;</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] x;</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] y;</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] x_sq;</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span>:N) x_sq[i] = x[i]*x[i];</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span>{</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> a;</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> b;</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> c;</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span>{</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Likelihood</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  y ~ normal(a + b*x + c*x_sq, sigma);</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  a ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  b ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>  c ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>  sigma ~ gamma(<span class="dv">2</span>, <span class="dv">1</span>);</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">STAN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode stan" tabindex="0"><code class="sourceCode stan"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">// cubic</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span>{</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N;</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] x;</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] y;</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] x_sq;</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] x_cu;</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span>:N) x_sq[i] = x[i]*x[i];</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span>:N) x_cu[i] = x_sq[i]*x[i];</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span>{</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> a;</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> b;</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> c;</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> d;</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span>{</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Likelihood</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  y ~ normal(a + b*x + c*x_sq + d*x_cu, sigma);</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  a ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  b ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>  c ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  sigma ~ gamma(<span class="dv">2</span>, <span class="dv">1</span>);</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre>
</div>
</div>
</section><section id="other-topics"><h2 class="section-heading">Other topics<a class="anchor" aria-label="anchor" href="#other-topics"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="hard-missing-observations-brownian-bridge">(hard) Missing observations: Brownian bridge<a class="anchor" aria-label="anchor" href="#hard-missing-observations-brownian-bridge"></a>
</h3>
<p>A time series is of length <span class="math inline">\(N=200\)</span>
is assumed to have been generated by the random walk process</p>
<p><span class="math display">\[x_t \sim N(x_{t-1}, \sigma^2).\]</span>
However, the observations at time points <span class="math inline">\(T=76, \ldots , 125\)</span> have been lost in a
fire.</p>
<p>Write a Stan program that estimates these missing values along with
the process variance <span class="math inline">\(\sigma^2.\)</span></p>
<p>Plot the time series and posterior draws for the missing values in
the same figure. Color the missing observations (that were not available
in the inference) in a different color.</p>
<p>Data can be simulated with the following piece of code:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Brownian bridge: random walk the a portion in missing values </span></span>
<span></span>
<span><span class="co"># Generate data</span></span>
<span><span class="va">N_obs_pre</span> <span class="op">&lt;-</span> <span class="fl">75</span></span>
<span><span class="va">N_mis</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">N_obs_post</span> <span class="op">&lt;-</span> <span class="fl">75</span></span>
<span></span>
<span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span></span>
<span><span class="va">y_full</span> <span class="op">&lt;-</span> <span class="fu">cumsum</span><span class="op">(</span><span class="fu">rnorm</span><span class="op">(</span><span class="va">N_obs_pre</span> <span class="op">+</span> <span class="va">N_mis</span> <span class="op">+</span> <span class="va">N_obs_post</span>, <span class="fl">0</span>, <span class="va">sigma</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">y_full</span></span>
<span><span class="va">y</span><span class="op">[</span><span class="op">(</span><span class="va">N_obs_pre</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">N_obs_pre</span> <span class="op">+</span> <span class="va">N_mis</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></code></pre>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Point</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div>
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
				<p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/edit/main/README.md" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a> 
        | <a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/" class="external-link">Source</a></p>
				<p><a href="https://github.com/carpentries-incubator/statistical-probabilistic-programming-r/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:velait@utu.fi">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="../LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p><a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">Template licensed under CC-BY 4.0</a> by <a href="https://carpentries.org" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.12.4" class="external-link">sandpaper (0.12.4)</a>,
        <a href="https://github.com/carpentries/pegboard" class="external-link">pegboard (0.5.3)</a>,
      and <a href="https://github.com/carpentries/varnish/tree/0.2.17" class="external-link">varnish (0.2.17)</a>.</p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
			<i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back to top"></i><br><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://carpentries-incubator.github.io/statistical-probabilistic-programming-r/instructor/aio.html",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://carpentries-incubator.github.io/statistical-probabilistic-programming-r/instructor/aio.html",
  "identifier": "https://carpentries-incubator.github.io/statistical-probabilistic-programming-r/instructor/aio.html",
  "dateCreated": "2023-06-16",
  "dateModified": "2023-06-27",
  "datePublished": "2023-06-27"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code -->
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

